# Stream A: GitHub API Reliability

**Files:** `haskell/control-server/src/Handler/Hook/SessionStart.hs`, `haskell/control-server/src/ExoTools/GHTools.hs`, new `haskell/control-server/src/Handler/Hook/GitHubRetry.hs`

**Issue:** GitHub API failures are silent and can hang indefinitely

## Core Fixes

- [ ] Log errors instead of `Left _err -> Nothing` (SessionStart.hs:99-102, 150-152)
- [ ] Add timeout to `getIssue`/`listIssues` calls (10 second default)

## Do It Right: Retry with Exponential Backoff

- [ ] Create `GitHubRetry.hs` module with:
  - `RetryConfig` type (maxRetries, baseDelay, maxDelay, retryableErrors)
  - `withRetry :: RetryConfig -> Eff (GitHub ': es) a -> Eff (GitHub ': Log ': es) a`
  - Exponential backoff: 1s -> 2s -> 4s -> 8s (capped)
  - Only retry on transient errors (rate limit, 5xx, network timeout)
  - Log each retry attempt with attempt number and delay
- [ ] Apply retry wrapper to SessionStart GitHub calls
- [ ] Apply retry wrapper to buildDashboard GitHub calls

## Do It Right: Structured Error Types

- [ ] Create `GitHubError` ADT in `GHTools.hs`:
  ```haskell
  data GitHubError
    = GHNotFound Int              -- Issue/PR doesn't exist
    | GHRateLimit UTCTime         -- Rate limited until time
    | GHNetworkError Text         -- Connection failed
    | GHTimeout                   -- Request timed out
    | GHPermissionDenied Text     -- Auth issue
    | GHUnexpected Int Text       -- Other HTTP error
  ```
- [ ] Update `getIssue`, `listIssues` return types to use `GitHubError`
- [ ] Add `isRetryable :: GitHubError -> Bool` helper

## Do It Right: Observability

- [ ] Add OpenTelemetry span for each GitHub API call
- [ ] Record attributes: endpoint, issue_number, retry_count, latency_ms
- [ ] Add counter metric for GitHub errors by type

## Tests

- [ ] Unit test: RetryConfig validation
- [ ] Unit test: isRetryable classification
- [ ] Integration test: Retry on simulated 503 (mock)

## Documentation

- [ ] Update `haskell/control-server/CLAUDE.md` with GitHub reliability section
- [ ] Document retry configuration env vars

## Verification

```bash
# 1. Retry logic
# Temporarily rate-limit GitHub (or mock), verify retries in logs:
# "[GitHub] Request failed (attempt 1/3), retrying in 1s..."
# "[GitHub] Request failed (attempt 2/3), retrying in 2s..."

# 2. Timeout
# Block network, verify timeout error (not hang):
# "[GitHub] Request timed out after 10s"

# 3. Structured errors
# Verify error types are logged with context:
# "[GitHub] GHRateLimit: retry after 2024-01-26T12:00:00Z"
```

## Key Locations to Read First

1. `haskell/control-server/src/Handler/Hook/SessionStart.hs` - See lines 99-102, 150-152 for silent error handling
2. `haskell/control-server/src/ExoTools/GHTools.hs` - Current GitHub effect implementation
3. `haskell/control-server/src/Handler/Dashboard.hs` - buildDashboard uses GitHub calls
