# Task: Make TUI Dashboard Actually Work

**Priority**: High (TL's #1 ask: "I need visibility into agent state and progress")
**Scope**: Large (long-running independent worktree)
**Type**: Feature completion

## Problem

The `agent-status` TUI exists but shows hardcoded dummy data:
- "Status: Idle" (always)
- "CPU: 12%, Mem: 256MB" (fake)
- Fake log lines
- Control buttons do nothing

No connection to control-server, no real data.

## Goal

A working TUI dashboard that shows:

```
â”Œâ”€ Agent Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Overview] [Logs] [Controls]                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Agents (3 active)                                                 â”‚
â”‚                                                                   â”‚
â”‚ â— agent-gh-123 [IN_PROGRESS] 15m elapsed                         â”‚
â”‚   Task: Implement auth middleware                                 â”‚
â”‚   Last activity: 2m ago (writing tests)                          â”‚
â”‚   Blockers: None                                                  â”‚
â”‚                                                                   â”‚
â”‚ â— agent-gh-124 [STUCK] 45m elapsed âš                              â”‚
â”‚   Task: Refactoring parser                                        â”‚
â”‚   Last activity: 20m ago (same grep pattern 5x)                  â”‚
â”‚   Blocker: Can't find function definition                        â”‚
â”‚                                                                   â”‚
â”‚ âœ“ agent-gh-125 [COMPLETED] 8m elapsed                            â”‚
â”‚   Task: Fixed typo in README                                      â”‚
â”‚   PR: #456 (awaiting review)                                      â”‚
â”‚                                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PRs (2 open)                                                      â”‚
â”‚ #456 [âœ“ CI] [ğŸ‘€ needs review] 2h old                             â”‚
â”‚ #455 [âŒ tests] [ğŸ” changes requested] 1d old                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Build: âœ“ main passing | 156/156 tests | Coverage: 78%            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     TCP :7432      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  agent-status   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  control-server      â”‚
â”‚  (Rust TUI)     â”‚    JSON-RPC/REST   â”‚  (Haskell)           â”‚
â”‚                 â”‚                    â”‚                      â”‚
â”‚  - Polls status â”‚    GET /status     â”‚  - Agent registry    â”‚
â”‚  - Shows agents â”‚    GET /agents     â”‚  - Spawn tracking    â”‚
â”‚  - Shows PRs    â”‚    GET /prs        â”‚  - Docker queries    â”‚
â”‚  - Shows CI     â”‚                    â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Implementation Phases

### Phase 1: Wire Up Connection

1. Add HTTP client to agent-status (reqwest or ureq)
2. Connect to control-server at `http://localhost:7432` (or `$EXOMONAD_CONTROL_HOST:$EXOMONAD_CONTROL_PORT`)
3. Create polling loop (every 2-5 seconds)
4. Handle connection errors gracefully (show "Disconnected" state)

### Phase 2: Agent Status Endpoint (Haskell side)

Add endpoint to control-server:

```
GET /api/agents
Response:
{
  "agents": [
    {
      "id": "agent-gh-123",
      "container_id": "exomonad-agent-abc123",
      "issue_number": 123,
      "status": "in_progress",
      "started_at": "2024-01-28T10:00:00Z",
      "last_activity": "2024-01-28T10:15:00Z",
      "last_action": "writing tests",
      "blocker": null
    }
  ]
}
```

Data sources:
- Docker API (via docker-ctl) for container list
- Zellij session info for tab names
- Could track spawn_agents calls in memory

### Phase 3: Real Overview Tab

Replace hardcoded data with:
- Agent count and status breakdown
- Time elapsed per agent (now - started_at)
- Stuck detection heuristic (no activity for N minutes)
- Issue/PR links

### Phase 4: Real Logs Tab

Options:
- Stream docker logs from agent containers
- Or: have agents send log events to control-server
- Or: tail OpenObserve via API

Start simple: `docker logs --tail 50 <container>` via docker-ctl

### Phase 5: Working Controls Tab

Implement actions:
- `[K]` Kill agent - calls docker-ctl stop
- `[R]` Restart agent - stop + respawn
- `[F]` Focus agent - switch Zellij tab
- `[P]` Ping agent - send keystroke "are you stuck?"

### Phase 6: PR/CI Status

Add GitHub data:
- Open PRs via `gh pr list --json`
- CI status via `gh run list --json`
- Show in dashboard footer or separate tab

## Files to Modify/Create

### Rust (agent-status)
| File | Action |
|------|--------|
| `Cargo.toml` | Add reqwest/ureq, serde_json |
| `src/main.rs` | Add async polling, state management |
| `src/api.rs` | NEW - Control server API client |
| `src/state.rs` | NEW - Dashboard state types |
| `src/views/overview.rs` | NEW - Real overview rendering |
| `src/views/logs.rs` | NEW - Log streaming |
| `src/views/controls.rs` | NEW - Action handlers |

### Haskell (control-server)
| File | Action |
|------|--------|
| `Server.hs` | Add `/api/agents` route |
| `AgentRegistry.hs` | NEW - Track spawned agents |
| `Handler/Status.hs` | NEW - Status endpoint handler |

## State Tracking Problem

Currently control-server doesn't track spawned agents after spawn_agents returns. Need to:

1. Store agent info in TVar/IORef on spawn
2. Update on container stop/completion
3. Periodically refresh from Docker (handle external kills)

Simple approach: spawn_agents writes to registry, status endpoint reads + enriches from Docker.

## Dependencies

- Phase 2 (Haskell endpoint) blocks Phase 3-5 (Rust display)
- Can parallelize: one engineer on Rust TUI, one on Haskell endpoint

## Testing

```bash
# Build TUI
cargo build -p agent-status

# Run TUI (needs control-server running)
./target/release/agent-status

# Verify tabs switch (Left/Right arrows)
# Verify q quits
# Verify data refreshes every few seconds
```

## Success Criteria

- [ ] TUI connects to control-server
- [ ] Overview shows real agent data (count, status, time elapsed)
- [ ] Logs tab shows actual container logs
- [ ] At least one control works (Kill or Focus)
- [ ] Handles disconnection gracefully
- [ ] Stuck detection works (visual indicator for idle agents)

## Stretch Goals

- [ ] PR status from GitHub
- [ ] CI status from GitHub Actions
- [ ] Sparkline for agent activity over time
- [ ] Sound/notification on agent completion or stuck
