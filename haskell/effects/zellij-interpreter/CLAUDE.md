# Zellij Effect Interpreter

Interprets the Zellij effect by calling the `zellij` CLI. Enables graphs to create tabs for parallel agent orchestration.

## When to Read This

Read this if you're:
- Working on spawn_agents or parallel agent orchestration
- Debugging Zellij tab creation issues
- Understanding Zellij session access patterns

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│ Graph (e.g., SpawnAgentsGraph)                              │
│   newTab TabConfig { tcName, tcLayout, tcCwd, tcEnv }       │
└────────────────────────────┬────────────────────────────────┘
                             │ Zellij effect
                             ▼
┌─────────────────────────────────────────────────────────────┐
│ Zellij Interpreter (runZellijIO)                            │
│   • checkZellijEnv → ZELLIJ or ZELLIJ_SESSION_NAME env      │
│   • newTab → zellij action new-tab ...                      │
│   • goToTab → zellij action go-to-tab-name ...              │
└────────────────────────────┬────────────────────────────────┘
                             │ CLI subprocess
                             ▼
┌─────────────────────────────────────────────────────────────┐
│ Zellij Process (local or remote session)                    │
│   Socket: $XDG_RUNTIME_DIR/zellij/<version>/<session>       │
└─────────────────────────────────────────────────────────────┘
```

## Effect Operations

| Operation | Description | CLI Command |
|-----------|-------------|-------------|
| `CheckZellijEnv` | Check if Zellij access is available | Reads `ZELLIJ` or `ZELLIJ_SESSION_NAME` env |
| `NewTab config` | Create a new tab with KDL layout | `zellij action new-tab --layout /tmp/exomonad-layouts/<name>.kdl` |
| `GoToTab tabId` | Switch focus to a tab | `zellij action go-to-tab-name <name>` |

**Note:** KDL layouts are generated by `exomonad-core` (Rust library) with baked-in environment variables and commands. See `rust/exomonad-core/src/layout/` for layout generation details.

## Environment Variables

| Variable | Description |
|----------|-------------|
| `ZELLIJ` | Set when running inside a Zellij pane (auto-set by Zellij) |
| `XDG_RUNTIME_DIR` | Zellij socket directory (e.g., `/run/user/1000`) |

## Error Types

| Error | Cause | Resolution |
|-------|-------|------------|
| `ZellijLayoutNotFound` | Layout file doesn't exist | Check `.zellij/worktree.kdl` exists |
| `ZellijCommandFailed` | CLI returned non-zero exit | Check Zellij session is running |

## Usage Example

```haskell
import ExoMonad.Zellij.Interpreter (runZellijIO)
import ExoMonad.Effects.Zellij

main = runM $ runZellijIO $ do
  mSession <- checkZellijEnv
  case mSession of
    Nothing -> error "Not in Zellij and no session name configured"
    Just _ -> do
      let cfg = TabConfig "worker" ".zellij/worktree.kdl" "/cwd" [("X", "Y")]
      newTab cfg
```

## Requirements

- Running inside a Zellij session (`ZELLIJ` env var set)
- `zellij` binary installed and in PATH
- For spawn_agents: `zellij-gen` binary to generate KDL layouts

## Related Documentation

- **[rust/exomonad-contrib/](../../../rust/exomonad-contrib/)** - AgentControlService (spawn_agents implementation)
- **[rust/exomonad-core/src/layout/](../../../rust/exomonad-core/src/layout/)** - KDL layout generator
- **[Root CLAUDE.md](../../../CLAUDE.md)** - Claude Code++ integration overview
