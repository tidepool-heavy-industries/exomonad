cabal-version:      3.4
name:               wasm-guest
version:            0.1.0.0
synopsis:           Haskell WASM Guest for ExoMonad
license:            MIT
author:             ExoMonad Team
maintainer:         maintainers@exomonad.io
build-type:         Simple

common shared
    default-language: GHC2021
    default-extensions:
        AllowAmbiguousTypes
        DataKinds
        DeriveAnyClass
        DeriveGeneric
        DerivingStrategies
        FlexibleContexts
        FlexibleInstances
        ForeignFunctionInterface
        GADTs
        LambdaCase
        OverloadedStrings
        ScopedTypeVariables
        TypeApplications
        TypeFamilies
        TypeOperators
        UndecidableInstances
    build-depends:
        base >= 4.16 && < 5,
        bytestring,
        text,
        aeson,
        polysemy >= 1.9,
        polysemy-plugin >= 0.4,
        unordered-containers

-- Internal library with shared tool infrastructure
library wasm-guest-internal
    import:           shared
    hs-source-dirs:   src
    exposed-modules:
        -- Tool infrastructure
        ExoMonad.Guest.Tool.Class
        ExoMonad.Guest.Tool.Mode
        ExoMonad.Guest.Tool.Record
        ExoMonad.Guest.Tool.Runtime
        -- Tools
        ExoMonad.Guest.Tools.Ping
        ExoMonad.Guest.Tools.Agent
        ExoMonad.Guest.Tools.FilePR
        -- Tool records
        ExoMonad.Guest.Records.Ping
        ExoMonad.Guest.Records.Agent
        ExoMonad.Guest.Records.FilePR
        -- Effects (for internal composition)
        ExoMonad.Guest.Effects.AgentControl
        ExoMonad.Guest.Effects.FileSystem
        ExoMonad.Guest.Effects.StopHook
        ExoMonad.Guest.HostCall
        -- Types
        ExoMonad.Guest.Types
        ExoMonad.Guest.Parsers
        -- Role tools
        Dev.Tools
        TL.Tools
    build-depends:
        extism-pdk >= 0.1 && < 1
    ghc-options: -fplugin=Polysemy.Plugin

-- TL role executable (orchestration tools)
executable wasm-guest-tl
    import:           shared
    hs-source-dirs:   src
    main-is:          TL/Main.hs
    build-depends:
        wasm-guest:wasm-guest-internal,
        extism-pdk >= 0.1 && < 1

    if arch(wasm32)
        ghc-options:
            -no-hs-main
            -optl-mexec-model=reactor
            -optl-Wl,--export=hs_init
            -optl-Wl,--export=handle_mcp_call
            -optl-Wl,--export=handle_pre_tool_use
            -optl-Wl,--export=handle_list_tools
            -optl-Wl,--allow-undefined

-- Dev role executable (ping tool only)
executable wasm-guest-dev
    import:           shared
    hs-source-dirs:   src
    main-is:          Dev/Main.hs
    build-depends:
        wasm-guest:wasm-guest-internal,
        extism-pdk >= 0.1 && < 1

    if arch(wasm32)
        ghc-options:
            -no-hs-main
            -optl-mexec-model=reactor
            -optl-Wl,--export=hs_init
            -optl-Wl,--export=handle_mcp_call
            -optl-Wl,--export=handle_pre_tool_use
            -optl-Wl,--export=handle_list_tools
            -optl-Wl,--allow-undefined
