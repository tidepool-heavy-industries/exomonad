cabal-version:      3.4
name:               wasm-guest
version:            0.1.0.0
synopsis:           Haskell WASM Guest for ExoMonad
license:            MIT
author:             ExoMonad Team
maintainer:         maintainers@exomonad.io
build-type:         Simple

common shared
    default-language: GHC2021
    build-depends:
        base >= 4.16 && < 5,
        bytestring,
        text,
        aeson,
        freer-simple

executable wasm-guest
    import:           shared
    main-is:          Main.hs
    hs-source-dirs:   src
    other-modules:
        ExoMonad.Guest.HostCall
        ExoMonad.Guest.Effects.AgentControl
        ExoMonad.Guest.Effects.FileSystem
        ExoMonad.Guest.Tools

    build-depends:
        extism-pdk >= 0.1 && < 1

    if arch(wasm32)
        ghc-options:
            -no-hs-main
            -optl-mexec-model=reactor
            -optl-Wl,--export=hs_init
            -optl-Wl,--export=handle_mcp_call
            -optl-Wl,--export=handle_pre_tool_use
            -optl-Wl,--export=handle_list_tools
            -optl-Wl,--allow-undefined

library wasm-guest-lib
    import:           shared
    hs-source-dirs:   src
    exposed-modules:
        ExoMonad.Guest.Tools
        ExoMonad.Guest.Parsers
    other-modules:
        ExoMonad.Guest.Effects.AgentControl
        ExoMonad.Guest.HostCall
    build-depends:
        extism-pdk >= 0.1 && < 1

test-suite wasm-guest-tests
    import:           shared
    type:             exitcode-stdio-1.0
    main-is:          Spec.hs
    hs-source-dirs:   test
    other-modules:
        ToolsSpec
        ParsersSpec
    build-depends:
        wasm-guest:wasm-guest-lib,
        hspec >= 2.10 && < 3
