cabal-version:      3.0
name:               exomonad-wasm
version:            0.1.0.0
synopsis:           WASM target for exomonad graphs - FFI exports and wire types
license:            MIT
author:             Inanna
build-type:         Simple

common warnings
    ghc-options: -Wall -Wno-missing-export-lists -Wincomplete-patterns -Wredundant-constraints -Wunused-packages

library
    import:           warnings
    exposed-modules:
        ExoMonad.Wasm.Prelude
        ExoMonad.Wasm.Effect
        ExoMonad.Wasm.Error
        ExoMonad.Wasm.GraphInput
        ExoMonad.Wasm.CfTool
        ExoMonad.Wasm.TypedTool
        ExoMonad.Wasm.ExampleGraph
        ExoMonad.Wasm.Habitica
        ExoMonad.Wasm.TestGraph
        ExoMonad.Wasm.LlmTestGraph
        ExoMonad.Wasm.WireTypes
        ExoMonad.Wasm.Conversion
        -- Interpreters (effects â†’ Yield effect)
        ExoMonad.Wasm.Interpreter
        ExoMonad.Wasm.Interpreter.LLM
        ExoMonad.Wasm.Interpreter.Log
        ExoMonad.Wasm.Interpreter.State
        -- High-level runner for portable handlers
        ExoMonad.Wasm.Run
        ExoMonad.Wasm.Ffi.Types
        ExoMonad.Wasm.Runner
        ExoMonad.Wasm.Roundtrip
        -- Unified Registry
        ExoMonad.Wasm.Registry
        ExoMonad.Wasm.Registry.Types
        ExoMonad.Wasm.Registry.Default
        ExoMonad.Wasm.Registry.TestGraph
        ExoMonad.Wasm.Registry.ExampleGraph
        -- Unified FFI
        ExoMonad.Wasm.Ffi.Unified
    build-depends:
        base >= 4.17 && < 5,
        exomonad-core,
        exomonad-generated-ts,
        exomonad-habitica,
        freer-simple >= 1.2 && < 2,
        aeson >= 2.1 && < 3,
        containers >= 0.6 && < 1,
        scientific >= 0.3 && < 1,
        template-haskell,
        text >= 2.0 && < 3,
        vector >= 0.12 && < 1

    -- WASM-specific build dependency
    if os(wasi)
        build-depends:
            ghc-experimental
        ghc-options:
            -no-hs-main
            -optl-mexec-model=reactor
            -optl-Wl,--export=hs_init
            -- NOTE: initRegistry NOT exported from library - only from reactor executable
            -- Unified FFI exports (4 total, never changes when adding graphs)
            -optl-Wl,--export=initialize
            -optl-Wl,--export=step
            -optl-Wl,--export=getGraphInfo
            -optl-Wl,--export=getGraphState
            -- Roundtrip exports (for property testing)
            -optl-Wl,--export=roundtripSerializableEffect
            -optl-Wl,--export=roundtripEffectResult
            -optl-Wl,--export=roundtripExecutionPhase
            -optl-Wl,--export=roundtripGraphState
            -optl-Wl,--export=roundtripStepOutput
            -- Graph info roundtrip exports
            -optl-Wl,--export=roundtripTypeInfoWire
            -optl-Wl,--export=roundtripGotoTargetWire
            -optl-Wl,--export=roundtripNodeInfoWire
            -optl-Wl,--export=roundtripEdgeInfoWire
            -optl-Wl,--export=roundtripGraphInfoWire

    hs-source-dirs:   src
    default-language: GHC2024
    default-extensions:
        DataKinds
        DeriveAnyClass
        DeriveGeneric
        DerivingStrategies
        DuplicateRecordFields
        GADTs
        LambdaCase
        MultiParamTypeClasses
        NoFieldSelectors
        OverloadedRecordDot
        OverloadedStrings
        TypeFamilies
        TypeOperators

test-suite exomonad-wasm-tests
    import:           warnings
    type:             exitcode-stdio-1.0
    main-is:          Spec.hs
    other-modules:
        WireTypesSpec
        TestGraphSpec
        ExampleGraphSpec
        LlmTestGraphSpec
        ProtocolConformanceSpec
        ProtocolPropertySpec
        RunnerSpec
        FfiSpec
        E2ESpec
        InterpreterSpec
        CodegenSyncSpec
        RoundtripSpec
        RegistrySpec
        TypedToolSpec
        ConversionSpec
        ToolResultOutcomeSpec
    build-depends:
        base >= 4.17 && < 5,
        hspec >= 2.10 && < 3,
        QuickCheck >= 2.14 && < 3,
        aeson >= 2.1 && < 3,
        bytestring >= 0.11 && < 1,
        containers >= 0.6 && < 1,
        scientific >= 0.3 && < 1,
        text >= 2.0 && < 3,
        vector >= 0.12 && < 1,
        exomonad-wasm,
        exomonad-core,
        exomonad-generated-ts
    hs-source-dirs:   test
    default-language: GHC2024
    default-extensions:
        OverloadedStrings
        OverloadedRecordDot

-- | WASM reactor executable for Cloudflare Workers.
-- This produces a self-contained WASM module with all FFI exports.
-- The library produces a dynamically-linked .so which won't work standalone.
executable exomonad-reactor
    import:           warnings
    main-is:          Reactor.hs
    build-depends:
        base >= 4.17 && < 5,
        exomonad-wasm
    hs-source-dirs:   reactor
    default-language: GHC2024
    if os(wasi)
        build-depends:
            ghc-experimental
        ghc-options:
            -no-hs-main
            -optl-mexec-model=reactor
            -optl-Wl,--export=hs_init
            -- Registry initialization (call once before any FFI calls)
            -optl-Wl,--export=initRegistry
            -- Unified FFI exports (4 total, never changes when adding graphs)
            -optl-Wl,--export=initialize
            -optl-Wl,--export=step
            -optl-Wl,--export=getGraphInfo
            -optl-Wl,--export=getGraphState
            -- Roundtrip exports (for property testing)
            -optl-Wl,--export=roundtripSerializableEffect
            -optl-Wl,--export=roundtripEffectResult
            -optl-Wl,--export=roundtripExecutionPhase
            -optl-Wl,--export=roundtripGraphState
            -optl-Wl,--export=roundtripStepOutput
            -- Graph info roundtrip exports
            -optl-Wl,--export=roundtripTypeInfoWire
            -optl-Wl,--export=roundtripGotoTargetWire
            -optl-Wl,--export=roundtripNodeInfoWire
            -optl-Wl,--export=roundtripEdgeInfoWire
            -optl-Wl,--export=roundtripGraphInfoWire

-- | Generates the TypeScript npm package with type-safe bindings.
-- Run with: cabal run generate-ts-package -- ./output
-- Output is a complete npm package ready for use by deploy/
executable generate-ts-package
    import:           warnings
    main-is:          GeneratePackage.hs
    build-depends:
        base >= 4.17 && < 5,
        directory,
        filepath,
        text >= 2.0 && < 3,
        exomonad-generated-ts,
        exomonad-wasm
    hs-source-dirs:   codegen
    default-language: GHC2024
    default-extensions:
        OverloadedStrings

-- | Generates golden JSON samples for cross-language protocol verification.
-- Run with: cabal run generate-golden-samples
-- Output goes to deploy/test/golden-samples.json
executable generate-golden-samples
    import:           warnings
    main-is:          GenerateGoldenSamples.hs
    build-depends:
        base >= 4.17 && < 5,
        aeson >= 2.1 && < 3,
        aeson-pretty >= 0.8 && < 1,
        bytestring >= 0.11 && < 1,
        text >= 2.0 && < 3,
        exomonad-wasm
    hs-source-dirs:   golden
    default-language: GHC2024
    default-extensions:
        OverloadedStrings
