cabal-version:      3.0
name:               exomonad-core
version:            0.1.0.0
synopsis:           Type-safe LLM agent loops with structured state and templates
license:            MIT
author:             Inanna
build-type:         Simple

common warnings
    -- NOTE: Polysemy.Plugin is enabled globally here to improve type inference
    -- for complex Polysemy effect stacks across the codebase. This can increase
    -- compilation time for all modules that import this stanza. If build times
    -- become an issue, consider moving -fplugin=Polysemy.Plugin to only those
    -- components or modules that require the improved inference.
    ghc-options: -Wall -Wincomplete-patterns -Wredundant-constraints -Wunused-packages -haddock -fwrite-interface -fplugin=Polysemy.Plugin

library
    import:           warnings
    exposed-modules:
        ExoMonad.Prelude
        Data.Stack
        ExoMonad
        ExoMonad.WASM
        ExoMonad.Platform
        ExoMonad.Effect
        ExoMonad.Effect.DevLog
        ExoMonad.Effect.Log
        ExoMonad.Effect.Metadata
        ExoMonad.Effect.Types
        ExoMonad.Effect.Decision
        ExoMonad.Effect.Decision.Types
        ExoMonad.Effect.TUI
        ExoMonad.Effects.JustExec
        ExoMonad.Role
        -- Types needed by WASM (no native dependencies)
        ExoMonad.Anthropic.Types
        ExoMonad.Tool.Wire
        ExoMonad.StructuredOutput
        ExoMonad.StructuredOutput.Class
        -- Typed LLM DSL (WASM-safe types and builders)
        ExoMonad.LLM.Types
        ExoMonad.LLM.Builder
        ExoMonad.LLM.Tools
        -- Template rendering (WASM-safe)
        ExoMonad.Template.Render
    -- Development/tooling modules (excluded from WASM builds)
    if !os(wasi)
      exposed-modules:
        -- Unified re-export module
        ExoMonad.Effects
        -- Native-only effects (require subprocesses)
        ExoMonad.Effect.LSP
        -- Native-only tooling
        ExoMonad.Schema
        ExoMonad.Schema.TH
        ExoMonad.StructuredOutput.Error
        ExoMonad.StructuredOutput.Generic
        ExoMonad.StructuredOutput.Instances
        ExoMonad.StructuredOutput.Prefix
        ExoMonad.Tool.Convert
        ExoMonad.Effects.Habitica
        ExoMonad.Effects.GitHub
        ExoMonad.Effects.Observability
        ExoMonad.Effects.UI
        ExoMonad.Effects.LLMProvider
        ExoMonad.Effects.Env
        ExoMonad.Effects.Git
        ExoMonad.Effects.Worktree
        ExoMonad.Effects.Effector
        ExoMonad.Effects.Justfile
        ExoMonad.Effects.FileSystem
        ExoMonad.Effects.Zellij
        ExoMonad.Question
        ExoMonad.Template.DependencyTree
        -- Typed LLM DSL (native-only: requires LLMProvider effect)
        ExoMonad.LLM
        ExoMonad.LLM.Effect
        ExoMonad.LLM.Interpret
        ExoMonad.LLM.Tools.TH
        ExoMonad.Middleware.Logging
      build-depends:
        exomonad-habitica,
        optparse-applicative >= 0.17 && < 1
    build-depends:
        base >= 4.17 && < 5,
        relude >= 1.2,
        microlens >= 0.4,
        microlens-mtl,
        microlens-ghc,
        PyF >= 0.11,
        co-log-core,
        polysemy >= 1.9,
        polysemy-plugin >= 0.4,
        ginger >= 0.10,
        aeson >= 2.1 && < 3,
        aeson-casing >= 0.2,
        deriving-aeson >= 0.2,
        text >= 2.0 && < 3,
        containers >= 0.6 && < 1,
        vector >= 0.13 && < 1,
        unordered-containers >= 0.2 && < 0.3,
        template-haskell >= 2.19 && < 3,
        mtl >= 2.3 && < 3,
        random >= 1.2 && < 2,
        bytestring >= 0.11 && < 1,
        parsec >= 3.1 && < 4,
        scientific >= 0.3 && < 1,
        time >= 1.12 && < 2,
        directory >= 1.3 && < 2,
        filepath >= 1.4 && < 2,
        uuid >= 1.3 && < 2,
        deepseq
    mixins:
        base hiding (Prelude),
        relude (Relude as Prelude)
    hs-source-dirs:   src
    -- Platform-specific source directories for NativeOnly constraint
    if os(wasi)
      hs-source-dirs: src-platform-wasm
    else
      hs-source-dirs: src-platform-native
    default-language: GHC2024
    default-extensions:
        DataKinds
        DeriveAnyClass
        DeriveGeneric
        DerivingStrategies
        DerivingVia
        DuplicateRecordFields
        GADTs
        LambdaCase
        MultiParamTypeClasses
        NoFieldSelectors
        OverloadedRecordDot
        OverloadedLabels
        OverloadedStrings
        StrictData
        TypeFamilies
        TypeOperators
        QuasiQuotes
        TemplateHaskell
        -- Graph DSL type-level programming extensions
        AllowAmbiguousTypes
        FlexibleContexts
        FlexibleInstances
        PolyKinds
        RankNTypes
        ScopedTypeVariables
        StandaloneKindSignatures
        TypeApplications
        UndecidableInstances

-- test-llm executable moved to exomonad-platform (requires HTTP client)

test-suite graph-validation-tests
    import:           warnings
    type:             exitcode-stdio-1.0
    main-is:          Spec.hs
    other-modules:
        StructuredOutputSpec
        DecisionSpec
        TUIWireFormatSpec
        ToolRecordTHSpec
        ToolSchemaBugSpec
        SchemaDerivationSpec
        Test.ExoMonad.MockLLM
    build-depends:
        base >= 4.17 && < 5,
        hspec >= 2.10 && < 3,
        process >= 1.6 && < 2,
        aeson >= 2.1 && < 3,
        bytestring >= 0.11 && < 1,
        containers >= 0.6 && < 1,
        optparse-applicative >= 0.18 && < 1,
        text >= 2.0 && < 3,
        vector >= 0.13 && < 1,
        polysemy >= 1.9,
        polysemy-plugin >= 0.4,
        time,
        lens,
        generic-lens,
        directory,
        filepath,
        exomonad-core
    hs-source-dirs:   test, test/golden/valid
    default-language: GHC2024
    default-extensions:
        DeriveAnyClass
        DeriveGeneric
        DerivingStrategies
        OverloadedStrings
        OverloadedRecordDot
        OverloadedLabels
        NoFieldSelectors
        TypeApplications