cabal-version:      3.0
name:               tidepool-core
version:            0.1.0.0
synopsis:           Type-safe LLM agent loops with structured state and templates
license:            MIT
author:             Inanna
build-type:         Simple

common warnings
    ghc-options: -Wall -Wincomplete-patterns -Wredundant-constraints -Wunused-packages -haddock -fwrite-interface

library
    import:           warnings
    exposed-modules:
        Tidepool.Prelude
        Data.Stack
        Tidepool
        Tidepool.WASM
        Tidepool.Platform
        Tidepool.Effect
        Tidepool.Effect.GraphContext
        Tidepool.Effect.Session
        Tidepool.Effect.Subgraph
        Tidepool.Effect.DevLog
        Tidepool.Effect.Metadata
        Tidepool.Effect.NodeMeta
        Tidepool.Effect.Types
        Tidepool.Effect.Decision
        Tidepool.Effect.Decision.Types
        Tidepool.Effect.TUI
        Tidepool.Graph
        Tidepool.Graph.Types
        Tidepool.Graph.Generic
        Tidepool.Graph.Generic.Core
        Tidepool.Graph.Goto
        Tidepool.Graph.Goto.Internal
        Tidepool.Graph.Errors
        Tidepool.Graph.Interpret
        Tidepool.Graph.Edges
        Tidepool.Graph.Validate
        Tidepool.Graph.Validate.RecordStructure
        Tidepool.Graph.Validate.ForkBarrier
        Tidepool.Graph.Reify
        Tidepool.Graph.MCPReify
        Tidepool.Graph.Export
        Tidepool.Graph.Memory
        Tidepool.Role
        -- Types needed by WASM (no native dependencies)
        Tidepool.Anthropic.Types
        Tidepool.Tool.Wire
        Tidepool.StructuredOutput
        Tidepool.StructuredOutput.Class
    -- Development/tooling modules (excluded from WASM builds)
    if !os(wasi)
      exposed-modules:
        -- Unified re-export module
        Tidepool.Effects
        -- Native-only effects (require subprocesses)
        Tidepool.Effect.LSP
        Tidepool.Effect.GHCi
        Tidepool.Effect.Gemini
        -- Native-only tooling
        Tidepool.Schema
        Tidepool.StructuredOutput.ClaudeCodeSchema
        Tidepool.StructuredOutput.DecisionTools
        Tidepool.StructuredOutput.Error
        Tidepool.StructuredOutput.Generic
        Tidepool.StructuredOutput.Instances
        Tidepool.StructuredOutput.Prefix
        Tidepool.Tool.Convert
        Tidepool.Graph.CLI
        Tidepool.Graph.Tool
        Tidepool.Graph.Template
        Tidepool.Effects.Habitica
        Tidepool.Effects.GitHub
        Tidepool.Effects.Observability
        Tidepool.Effects.UI
        Tidepool.Effects.LLMProvider
        Tidepool.Effects.Env
        Tidepool.Effects.Git
        Tidepool.Effects.Worktree
        Tidepool.Effects.Cabal
        Tidepool.Effects.Effector
        Tidepool.Effects.Justfile
        Tidepool.Effects.DockerSpawner
        Tidepool.Effects.FileSystem
        Tidepool.Effects.Zellij
        Tidepool.Graph.Mermaid
        Tidepool.Graph.Example
        Tidepool.Graph.Example.Context
        Tidepool.Graph.Docs
        Tidepool.Graph.Interpret.Instrumented
        Tidepool.Question
        Tidepool.Template.DependencyTree
      build-depends:
        tidepool-habitica,
        optparse-applicative >= 0.17 && < 1
    build-depends:
        base >= 4.17 && < 5,
        freer-simple >= 1.2 && < 2,
        ginger >= 0.10,
        aeson >= 2.1 && < 3,
        text >= 2.0 && < 3,
        containers >= 0.6 && < 1,
        vector >= 0.13 && < 1,
        unordered-containers >= 0.2 && < 0.3,
        template-haskell >= 2.19 && < 3,
        mtl >= 2.3 && < 3,
        optics >= 0.4 && < 1,
        random >= 1.2 && < 2,
        bytestring >= 0.11 && < 1,
        parsec >= 3.1 && < 4,
        scientific >= 0.3 && < 1,
        time >= 1.12 && < 2,
        directory >= 1.3 && < 2,
        filepath >= 1.4 && < 2,
        uuid >= 1.3 && < 2
    hs-source-dirs:   src
    -- Platform-specific source directories for NativeOnly constraint
    if os(wasi)
      hs-source-dirs: src-platform-wasm
    else
      hs-source-dirs: src-platform-native
    default-language: GHC2024
    default-extensions:
        DataKinds
        DeriveAnyClass
        DeriveGeneric
        DerivingStrategies
        DerivingVia
        DuplicateRecordFields
        GADTs
        LambdaCase
        MultiParamTypeClasses
        NoFieldSelectors
        OverloadedRecordDot
        OverloadedStrings
        TypeFamilies
        TypeOperators
        QuasiQuotes
        TemplateHaskell
        -- Graph DSL type-level programming extensions
        AllowAmbiguousTypes
        FlexibleContexts
        FlexibleInstances
        PolyKinds
        RankNTypes
        ScopedTypeVariables
        StandaloneKindSignatures
        TypeApplications
        UndecidableInstances

-- test-llm executable moved to tidepool-platform (requires HTTP client)

test-suite graph-validation-tests
    import:           warnings
    type:             exitcode-stdio-1.0
    main-is:          Spec.hs
    other-modules:
        CLISpec
        CLITestTypes
        CLIGraphSpec
        CLIGraphTypes
        GraphValidationSpec
        LLMNodeInterpretSpec
        MemorySerializationSpec
        MermaidSpec
        StructuredOutputSpec
        OneOfSpec
        InjectTargetSpec
        GotoChoiceSpec
        CallHandlerSpec
        DispatchGotoSpec
        ConvertTransitionHintSpec
        ToolTransitionIntegrationSpec
        DecisionToolsSpec
        DecisionSpec
        Test.Tidepool.MockLLM
        -- Golden test files (compile-only validation)
        BranchingLogicRecord
        ConfigRecordGraph
        FanInGraphRecord
        MixedLLMLogicRecord
        SelfLoopRecord
        SimpleLinearRecord
    build-depends:
        base >= 4.17 && < 5,
        hspec >= 2.10 && < 3,
        process >= 1.6 && < 2,
        aeson >= 2.1 && < 3,
        bytestring >= 0.11 && < 1,
        containers >= 0.6 && < 1,
        optparse-applicative >= 0.18 && < 1,
        text >= 2.0 && < 3,
        vector >= 0.13 && < 1,
        freer-simple >= 1.2 && < 2,
        time,
        tidepool-core
    hs-source-dirs:   test, test/golden/valid
    default-language: GHC2024
    default-extensions:
        DeriveAnyClass
        DeriveGeneric
        DerivingStrategies
        OverloadedStrings
        OverloadedRecordDot
        TypeApplications
