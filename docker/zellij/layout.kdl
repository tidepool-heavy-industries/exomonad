// Main Zellij layout for container separation architecture
// Panes connect to agent containers via docker attach

layout {
    default_tab_template {
        children
        pane size=1 borderless=true {
            plugin location="zellij:compact-bar"
        }
    }

    // Template for Agent tabs: Main interaction area + Status Dashboard (20% bottom) + tab bar
    tab_template name="agent" {
        pane split_direction="vertical" {
            pane split_direction="horizontal" {
                children
                pane name="Agent Status" size="20%" {
                    command "bash"
                    // Ensure we point to the mounted socket
                    args "-c" "export EXOMONAD_CONTROL_SOCKET=/sockets/control.sock; while true; do agent-status; echo '⚠️ Agent Status exited. Restarting in 2s...'; sleep 2; done"
                }
            }
            pane size=1 borderless=true {
                plugin location="zellij:compact-bar"
            }
        }
    }

    // TL (Tech Lead) agent - main coding agent
    // Use --detach-keys to avoid conflict with outer docker attach (Ctrl+p,q)
    agent name="TL" focus=true {
        pane name="TL" focus=true {
            command "bash"
            args "-c" "while true; do docker attach --detach-keys 'ctrl-],]' exomonad-tl; echo '[TL disconnected - reconnecting in 2s]'; sleep 2; done"
        }
    }

    // PM (Project Manager) agent - planning and coordination
    agent name="PM" {
        pane name="PM" {
            command "bash"
            args "-c" "while true; do docker attach --detach-keys 'ctrl-],]' exomonad-pm; echo '[PM disconnected - reconnecting in 2s]'; sleep 2; done"
        }
    }

    tab name="Infrastructure" {
        pane split_direction="horizontal" {
            // Control server logs
            pane name="Control Server" size="60%" {
                command "docker"
                args "logs" "-f" "exomonad-control-server"
            }

            pane split_direction="vertical" {
                // Container status
                pane name="Status" {
                    command "bash"
                    args "-c" "watch -c -n5 'docker ps --format \"table {{.Names}}\\t{{.Status}}\\t{{.Ports}}\" --filter name=exomonad'"
                }
            }
        }
    }
}