services:
  orchestrator:
    # Use linux/amd64 to ensure consistent binary execution, especially on Apple Silicon
    platform: linux/amd64
    build:
      context: .
      dockerfile: docker/orchestrator/Dockerfile
      target: runtime
    container_name: tidepool-orchestrator
    tty: true  # Allocate pseudo-TTY to prevent Zellij ENOTTY crash
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - HANGAR_ROOT=/worktrees
      - TIDEPOOL_CONTROL_SOCKET=/sockets/control.sock
      - TIDEPOOL_TUI_SOCKET=/sockets/tui.sock
      - CLAUDE_CONFIG_DIR=/home/user/.claude-orchestrator
      # Claude Code headless environment variables
      - IS_DEMO=true
      - CLAUDE_CODE_DISABLE_INSTALLATION_CHECKS=1
      - DISABLE_AUTOUPDATER=1
      - DISABLE_TELEMETRY=1
    volumes:
      - .:/worktrees
      - tidepool-sockets:/sockets
      # Granular auth mounts to prevent history corruption
      - ${HOME}/.claude/.credentials.json:/mnt/secrets/.credentials.json:rw
      - ${HOME}/.claude/settings.json:/mnt/secrets/settings.json:ro
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "7432:7432"
      - "8080:8080"  # Zellij web client
    restart: unless-stopped
    command: ["orchestrator"]

  orchestrator-dev:
    # Development profile with HLS
    profiles: ["dev"]
    platform: linux/amd64
    build:
      context: .
      dockerfile: docker/orchestrator/Dockerfile
      target: dev
    container_name: tidepool-orchestrator-dev
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - HANGAR_ROOT=/worktrees
      - CLAUDE_CONFIG_DIR=/home/user/.claude-orchestrator
    volumes:
      - .:/worktrees
      - tidepool-sockets:/sockets
      # Granular auth mounts
      - ${HOME}/.claude/.credentials.json:/mnt/secrets/.credentials.json:rw
      - ${HOME}/.claude/settings.json:/mnt/secrets/settings.json:ro
    command: ["cabal", "repl", "tidepool-control-server"]

volumes:
  tidepool-sockets:
    name: tidepool-sockets