# Container Separation Architecture
# ================================
# - zellij: Minimal visual multiplexer (human attaches here)
# - control-server: Dedicated Haskell MCP server
# - tl/pm: Named agent containers (always running)
# - docker-spawner: Container lifecycle management

services:
  # ===========================================================================
  # Control Server: MCP server for all agents
  # ===========================================================================
  control-server:
    build:
      context: .
      dockerfile: docker/control-server/Dockerfile
    container_name: tidepool-control-server
    platform: linux/amd64
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - TIDEPOOL_CONTROL_SOCKET=/sockets/control.sock
      - TIDEPOOL_TUI_SOCKET=/sockets/tui.sock
      - GEMMA_ENDPOINT=${GEMMA_ENDPOINT:-http://host.docker.internal:11434}
      - DOCKER_SPAWNER_URL=http://docker-spawner:7435
      - XDG_RUNTIME_DIR=/run/user/1000
      - ZELLIJ_SESSION_NAME=main
    volumes:
      - tidepool-sockets:/sockets
      - tidepool-zellij:/run/user/1000
      - tidepool-gh-auth:/home/user/.config/gh
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD-SHELL", "socat -u OPEN:/dev/null UNIX-CONNECT:/sockets/control.sock || exit 1"]
      interval: 5s
      timeout: 2s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - tidepool-internal

  # ===========================================================================
  # Zellij: Visual multiplexer (human attaches here)
  # ===========================================================================
  zellij:
    build:
      context: .
      dockerfile: docker/zellij/Dockerfile
    container_name: tidepool-zellij
    platform: linux/amd64
    tty: true
    stdin_open: true
    depends_on:
      tl:
        condition: service_started
      pm:
        condition: service_started
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - tidepool-zellij:/run/user/1000
      - tidepool-sockets:/sockets
      - tidepool-worktrees:/worktrees
    restart: unless-stopped
    networks:
      - tidepool-internal

  # ===========================================================================
  # TL (Tech Lead): Main coding agent
  # ===========================================================================
  tl:
    build:
      context: .
      dockerfile: docker/claude-agent/Dockerfile
    container_name: tidepool-tl
    platform: linux/amd64
    tty: true
    stdin_open: true
    environment:
      - TIDEPOOL_ROLE=tl
      - CONTROL_SERVER_URL=http://control-server:7432
      - MANTLE_CONTROL_SOCKET=/sockets/control.sock
    volumes:
      - tidepool-worktrees:/workspace
      - tidepool-sockets:/sockets
      - tidepool-claude-tl:/home/agent/.claude
      - tidepool-gh-auth:/home/agent/.config/gh
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      control-server:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - tidepool-internal

  # ===========================================================================
  # PM (Project Manager): Planning and coordination agent
  # ===========================================================================
  pm:
    build:
      context: .
      dockerfile: docker/claude-agent/Dockerfile
    container_name: tidepool-pm
    platform: linux/amd64
    tty: true
    stdin_open: true
    environment:
      - TIDEPOOL_ROLE=pm
      - CONTROL_SERVER_URL=http://control-server:7432
      - MANTLE_CONTROL_SOCKET=/sockets/control.sock
    volumes:
      - tidepool-worktrees:/workspace
      - tidepool-sockets:/sockets
      - tidepool-claude-pm:/home/agent/.claude
      - tidepool-gh-auth:/home/agent/.config/gh
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      control-server:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - tidepool-internal

  # ===========================================================================
  # Docker Spawner: Container lifecycle management
  # ===========================================================================
  docker-spawner:
    build:
      context: .
      dockerfile: docker/docker-spawner/Dockerfile
    container_name: tidepool-docker-spawner
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - tidepool-worktrees:/worktrees:rw
    environment:
      - RUST_LOG=info
      - HOST_UID=${HOST_UID:-1000}
      - HOST_GID=${HOST_GID:-1000}
      - TIDEPOOL_AGENT_IMAGE=${TIDEPOOL_AGENT_IMAGE:-tidepool-agent:latest}
      - TIDEPOOL_NETWORK=tidepool-internal
    ports:
      - "7435:7435"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7435/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - tidepool-internal

  # ===========================================================================
  # OpenObserve: Observability backend (optional)
  # ===========================================================================
  openobserve:
    profiles: ["monitoring"]
    image: public.ecr.aws/zinclabs/openobserve:latest
    container_name: tidepool-openobserve
    restart: unless-stopped
    ports:
      - "5080:5080"
      - "5081:5081"
    environment:
      - ZO_DATA_DIR=/data
      - ZO_ROOT_USER_EMAIL=${OPENOBSERVE_EMAIL:-admin@tidepool.local}
      - ZO_ROOT_USER_PASSWORD=${OPENOBSERVE_PASSWORD:-tidepool-dev}
      - ZO_MAX_FILE_SIZE_IN_MEMORY=128
      - ZO_MEMORY_CACHE_MAX_SIZE=256
      - ZO_FILE_MOVE_THREAD_NUM=1
    volumes:
      - tidepool-openobserve:/data
    networks:
      - tidepool-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5080/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ===========================================================================
  # DEPRECATED: Orchestrator (kept for rollback)
  # ===========================================================================
  orchestrator:
    profiles: ["legacy"]
    platform: linux/amd64
    build:
      context: .
      dockerfile: docker/orchestrator/Dockerfile
      target: orchestrator
    container_name: tidepool-orchestrator
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    depends_on:
      control-server:
        condition: service_healthy
    tty: true
    stdin_open: true
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - HANGAR_ROOT=/worktrees
      - TIDEPOOL_CONTROL_SOCKET=/sockets/control.sock
      - TIDEPOOL_TUI_SOCKET=/sockets/tui.sock
      - CLAUDE_CONFIG_DIR=/home/user/.claude
      - RUST_BACKTRACE=full
      - TIDEPOOL_REPO_URL=${TIDEPOOL_REPO_URL:-git@github.com:tidepool-heavy-industries/tidepool.git}
      - TIDEPOOL_REPO_BRANCH=${TIDEPOOL_REPO_BRANCH:-main}
      - CLAUDE_CODE_DISABLE_INSTALLATION_CHECKS=1
      - DISABLE_AUTOUPDATER=1
      - DISABLE_TELEMETRY=1
    volumes:
      - tidepool-repo:/worktrees
      - tidepool-sockets:/sockets
      - tidepool-claude-auth:/home/user/.claude
      - tidepool-gh-auth:/home/user/.config/gh
      - tidepool-ssh-keys:/home/user/.ssh
      - tidepool-zellij:/run/user/1000
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped
    networks:
      - tidepool-internal
    command: ["orchestrator"]

volumes:
  tidepool-sockets:
    name: tidepool-sockets
  tidepool-claude-tl:
    name: tidepool-claude-tl
  tidepool-claude-pm:
    name: tidepool-claude-pm
  tidepool-claude-auth:
    name: tidepool-claude-auth
  tidepool-gh-auth:
    name: tidepool-gh-auth
  tidepool-repo:
    name: tidepool-repo
  tidepool-ssh-keys:
    name: tidepool-ssh-keys
  tidepool-zellij:
    name: tidepool-zellij
  tidepool-openobserve:
    name: tidepool-openobserve
  tidepool-worktrees:
    name: tidepool-worktrees

networks:
  tidepool-internal:
    name: tidepool-internal
    driver: bridge