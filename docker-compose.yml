services:
  control-server:
    # Backend: Haskell MCP server + LSP integration
    platform: linux/amd64
    build:
      context: .
      dockerfile: docker/orchestrator/Dockerfile
      target: control-server
    container_name: tidepool-control-server
    # Memory limits prevent OOM kills that cause garbled terminals
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - TIDEPOOL_CONTROL_SOCKET=/sockets/control.sock
      - TIDEPOOL_TUI_SOCKET=/sockets/tui.sock
      - GEMMA_ENDPOINT=${GEMMA_ENDPOINT:-http://host.docker.internal:11434}
      # Zellij cross-container access (shared socket with orchestrator)
      - XDG_RUNTIME_DIR=/run/user/1000
      - ZELLIJ_SESSION_NAME=orchestrator
      # Observability (optional - set OTEL_EXPORTER_OTLP_ENDPOINT in .env to enable)
      # - OTEL_EXPORTER_OTLP_ENDPOINT=http://openobserve:5081
      # - OTEL_EXPORTER_OTLP_HEADERS=Authorization=Basic ${OPENOBSERVE_AUTH_HEADER}
    volumes:
      - tidepool-sockets:/sockets
      - tidepool-zellij:/run/user/1000
    healthcheck:
      # Use socat to verify actual connectivity, not just file existence
      test: ["CMD-SHELL", "socat -u OPEN:/dev/null UNIX-CONNECT:/sockets/control.sock || exit 1"]
      interval: 5s
      timeout: 2s
      retries: 5
      start_period: 5s
    restart: unless-stopped
    networks:
      - tidepool-internal

  openobserve:
    # Observability backend (optional - use with: docker compose --profile monitoring up)
    profiles: ["monitoring"]
    image: public.ecr.aws/zinclabs/openobserve:latest
    container_name: tidepool-openobserve
    restart: unless-stopped
    ports:
      - "5080:5080"  # Web UI & HTTP API
      - "5081:5081"  # OTLP gRPC ingestion
    environment:
      - ZO_DATA_DIR=/data
      - ZO_ROOT_USER_EMAIL=${OPENOBSERVE_EMAIL:-admin@tidepool.local}
      - ZO_ROOT_USER_PASSWORD=${OPENOBSERVE_PASSWORD:-tidepool-dev}
      # Memory tuning for Docker (prevent OOM)
      - ZO_MAX_FILE_SIZE_IN_MEMORY=128
      - ZO_MEMORY_CACHE_MAX_SIZE=256
      - ZO_FILE_MOVE_THREAD_NUM=1
    volumes:
      - tidepool-openobserve:/data
    networks:
      - tidepool-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5080/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3

  orchestrator:
    # Frontend: Zellij + Claude Code CLI (attach via: docker exec -it --user user tidepool-orchestrator zellij attach orchestrator)
    platform: linux/amd64
    build:
      context: .
      dockerfile: docker/orchestrator/Dockerfile
      target: orchestrator
    container_name: tidepool-orchestrator
    # Memory limits prevent OOM kills during Zellij resize/scroll operations
    # Zellij maintains scrollback buffers per pane (reduced to 2000 lines in config)
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    depends_on:
      control-server:
        condition: service_healthy
    tty: true         # Allocate pseudo-TTY (-t)
    stdin_open: true  # Keep stdin open (-i) - prevents Zellij from detecting EOF and exiting
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - HANGAR_ROOT=/worktrees
      - TIDEPOOL_CONTROL_SOCKET=/sockets/control.sock
      - TIDEPOOL_TUI_SOCKET=/sockets/tui.sock
      - CLAUDE_CONFIG_DIR=/home/user/.claude
      - RUST_BACKTRACE=full
      # Git repo to clone (for remote Docker where bind mounts don't work)
      - TIDEPOOL_REPO_URL=${TIDEPOOL_REPO_URL:-git@github.com:tidepool-heavy-industries/tidepool.git}
      - TIDEPOOL_REPO_BRANCH=${TIDEPOOL_REPO_BRANCH:-main}
      # Claude Code environment
      - CLAUDE_CODE_DISABLE_INSTALLATION_CHECKS=1
      - DISABLE_AUTOUPDATER=1
      - DISABLE_TELEMETRY=1
    volumes:
      - tidepool-repo:/worktrees
      - tidepool-sockets:/sockets
      - tidepool-claude-auth:/home/user/.claude
      - tidepool-ssh-keys:/home/user/.ssh
      - tidepool-zellij:/run/user/1000
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped
    networks:
      - tidepool-internal
    command: ["orchestrator"]

  orchestrator-dev:
    # Development profile with HLS
    profiles: ["dev"]
    platform: linux/amd64
    build:
      context: .
      dockerfile: docker/orchestrator/Dockerfile
      target: dev
    container_name: tidepool-orchestrator-dev
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - HANGAR_ROOT=/worktrees
      - CLAUDE_CONFIG_DIR=/home/user/.claude
      - TIDEPOOL_REPO_URL=${TIDEPOOL_REPO_URL:-git@github.com:tidepool-heavy-industries/tidepool.git}
      - TIDEPOOL_REPO_BRANCH=${TIDEPOOL_REPO_BRANCH:-main}
    volumes:
      - tidepool-repo:/worktrees
      - tidepool-sockets:/sockets
      - tidepool-claude-auth:/home/user/.claude
      - tidepool-ssh-keys:/home/user/.ssh
    command: ["cabal", "repl", "tidepool-control-server"]

  agent-1:
    build:
      context: .
      dockerfile: docker/claude-agent/Dockerfile
    hostname: agent-1
    networks:
      - tidepool-internal
    depends_on:
      - orchestrator
    command: ["sleep", "infinity"]

volumes:
  tidepool-sockets:
    name: tidepool-sockets
  tidepool-claude-auth:
    name: tidepool-claude-auth
  tidepool-repo:
    name: tidepool-repo
  tidepool-ssh-keys:
    name: tidepool-ssh-keys
  tidepool-zellij:
    name: tidepool-zellij
  tidepool-openobserve:
    name: tidepool-openobserve

networks:
  tidepool-internal:
    name: tidepool-internal
    driver: bridge