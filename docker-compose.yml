services:
  control-server:
    # Backend: Haskell MCP server + LSP integration
    platform: linux/amd64
    build:
      context: .
      dockerfile: docker/orchestrator/Dockerfile
      target: control-server
    container_name: tidepool-control-server
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - TIDEPOOL_CONTROL_SOCKET=/sockets/control.sock
      - TIDEPOOL_TUI_SOCKET=/sockets/tui.sock
      - GEMMA_ENDPOINT=${GEMMA_ENDPOINT:-http://host.docker.internal:11434}
    volumes:
      - tidepool-sockets:/sockets
    healthcheck:
      # Use socat to verify actual connectivity, not just file existence
      test: ["CMD-SHELL", "socat -u OPEN:/dev/null UNIX-CONNECT:/sockets/control.sock || exit 1"]
      interval: 5s
      timeout: 2s
      retries: 5
      start_period: 5s
    restart: unless-stopped
    networks:
      - tidepool-internal

  orchestrator:
    # Frontend: Zellij web UI + Claude Code CLI
    platform: linux/amd64
    build:
      context: .
      dockerfile: docker/orchestrator/Dockerfile
      target: orchestrator
    container_name: tidepool-orchestrator
    depends_on:
      control-server:
        condition: service_healthy
    tty: true         # Allocate pseudo-TTY (-t)
    stdin_open: true  # Keep stdin open (-i) - prevents Zellij from detecting EOF and exiting
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - CLAUDE_CODE_OAUTH_KEY=${CLAUDE_CODE_OAUTH_KEY}
      - HANGAR_ROOT=/worktrees
      - TIDEPOOL_CONTROL_SOCKET=/sockets/control.sock
      - TIDEPOOL_TUI_SOCKET=/sockets/tui.sock
      - CLAUDE_CONFIG_DIR=/home/user/.claude-orchestrator
      # Claude Code headless environment variables
      - IS_DEMO=true
      - CLAUDE_CODE_DISABLE_INSTALLATION_CHECKS=1
      - DISABLE_AUTOUPDATER=1
      - DISABLE_TELEMETRY=1
    volumes:
      - .:/worktrees
      - tidepool-sockets:/sockets
      # Granular auth mounts to prevent history corruption
      - ${HOME}/.claude/.credentials.json:/mnt/secrets/.credentials.json:rw
      - ${HOME}/.claude/settings.json:/mnt/secrets/settings.json:ro
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "8080:8080"  # Zellij web client
    restart: unless-stopped
    networks:
      - tidepool-internal
    command: ["orchestrator"]

  orchestrator-dev:
    # Development profile with HLS
    profiles: ["dev"]
    platform: linux/amd64
    build:
      context: .
      dockerfile: docker/orchestrator/Dockerfile
      target: dev
    container_name: tidepool-orchestrator-dev
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - CLAUDE_CODE_OAUTH_KEY=${CLAUDE_CODE_OAUTH_KEY}
      - HANGAR_ROOT=/worktrees
      - CLAUDE_CONFIG_DIR=/home/user/.claude-orchestrator
    volumes:
      - .:/worktrees
      - tidepool-sockets:/sockets
      # Granular auth mounts
      - ${HOME}/.claude/.credentials.json:/mnt/secrets/.credentials.json:rw
      - ${HOME}/.claude/settings.json:/mnt/secrets/settings.json:ro
    command: ["cabal", "repl", "tidepool-control-server"]

  agent-1:
    build:
      context: .
      dockerfile: docker/claude-agent/Dockerfile
    hostname: agent-1
    networks:
      - tidepool-internal
    depends_on:
      - orchestrator
    command: ["sleep", "infinity"]

volumes:
  tidepool-sockets:
    name: tidepool-sockets

networks:
  tidepool-internal:
    name: tidepool-internal
    driver: bridge