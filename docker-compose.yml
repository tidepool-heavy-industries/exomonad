# Container Separation Architecture
# ================================
# - zellij: Minimal visual multiplexer (human attaches here)
# - control-server: Dedicated Haskell MCP server (with docker-ctl CLI)
# - tl/pm: Named agent containers (always running)

services:
  # ===========================================================================
  # Control Server: MCP server for all agents
  # ===========================================================================
  control-server:
    extends:
      file: compose.base.yml
      service: docker-socket-access
    init: true
    image: exomonad-control-server:${TAG:-latest}
    build:
      context: .
      dockerfile: docker/control-server/Dockerfile
      args:
        GIT_SHA: ${GIT_SHA:-unknown}
    container_name: exomonad-control-server
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GH_TOKEN=${GH_TOKEN}
      - GITHUB_REPO=${GITHUB_REPO:-exomonad-ai/exomonad}
      - EXOMONAD_CONTROL_SOCKET=/sockets/control.sock
      - EXOMONAD_TUI_SOCKET=/sockets/tui.sock
      - EXOMONAD_WORKTREES_PATH=/worktrees
      - EXOMONAD_WORKTREES_VOLUME=exomonad-worktrees
      - EXOMONAD_SOCKETS_PATH=/sockets
      - EXOMONAD_PROJECT_DIR=/repo
      - GEMMA_ENDPOINT=${GEMMA_ENDPOINT:-http://host.docker.internal:11434}
      - HOST_UID=${HOST_UID:-1000}
      - HOST_GID=${HOST_GID:-1000}
      - EXOMONAD_AGENT_IMAGE=${EXOMONAD_AGENT_IMAGE:-exomonad-agent:latest}
      - EXOMONAD_NETWORK=exomonad-internal
      - RUST_LOG=info
      - XDG_RUNTIME_DIR=/run/user/1000
      - ZELLIJ_SESSION_NAME=main
    volumes:
      - exomonad-sockets:/sockets
      - exomonad-zellij:/run/user/1000
      - exomonad-gh-auth:/home/user/.config/gh
      - exomonad-worktrees:/worktrees:rw
      # Named volume for repo (cloned on first start via entrypoint)
      # Cannot use bind mounts - Docker runs on remote NixOS, not local macOS
      - exomonad-repo:/repo:rw
    working_dir: /repo
    healthcheck:
      test: ["CMD-SHELL", "socat -u OPEN:/dev/null UNIX-CONNECT:/sockets/control.sock || exit 1"]
      interval: 5s
      timeout: 2s
      retries: 5
      start_period: 10s
    restart: on-failure:5
    networks:
      - exomonad-internal

  # ===========================================================================
  # Zellij: Visual multiplexer (human attaches here)
  # ===========================================================================
  zellij:
    extends:
      file: compose.base.yml
      service: docker-socket-access
    init: true
    image: exomonad-zellij:${TAG:-latest}
    build:
      context: .
      dockerfile: docker/zellij/Dockerfile
      args:
        GIT_SHA: ${GIT_SHA:-unknown}
    container_name: exomonad-zellij
    tty: true
    stdin_open: true
    depends_on:
      tl:
        condition: service_healthy
      pm:
        condition: service_healthy
    volumes:
      - exomonad-zellij:/run/user/1000
      - exomonad-sockets:/sockets
      - exomonad-worktrees:/worktrees
    restart: "no"
    networks:
      - exomonad-internal

  # ===========================================================================
  # TL (Tech Lead): Main coding agent
  # ===========================================================================
  tl:
    extends:
      file: compose.base.yml
      service: docker-socket-access
    init: true
    image: exomonad-agent:${TAG:-latest}
    build:
      context: .
      dockerfile: docker/claude-agent/Dockerfile
      args:
        GIT_SHA: ${GIT_SHA:-unknown}
    container_name: exomonad-tl
    tty: true
    stdin_open: true
    environment:
      - EXOMONAD_ROLE=tl
      - CONTROL_SERVER_URL=http://control-server:7432
      - EXOMONAD_CONTROL_SOCKET=/sockets/control.sock
    volumes:
      # Named volume for repo (cloned on first start)
      # Cannot use bind mounts - Docker runs on remote NixOS, not local macOS
      - exomonad-repo:/workspace/tl
      # Worktrees volume for spawned agents
      - exomonad-worktrees:/worktrees
      - exomonad-sockets:/sockets
      - exomonad-claude-auth:/home/agent/.claude
      - exomonad-gh-auth:/home/agent/.config/gh
    depends_on:
      control-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'node.*claude' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 30s
    restart: on-failure:5
    networks:
      - exomonad-internal

  # ===========================================================================
  # PM (Project Manager): Planning and coordination agent
  # ===========================================================================
  pm:
    extends:
      file: compose.base.yml
      service: docker-socket-access
    init: true
    image: exomonad-agent:${TAG:-latest}
    build:
      context: .
      dockerfile: docker/claude-agent/Dockerfile
      args:
        GIT_SHA: ${GIT_SHA:-unknown}
    container_name: exomonad-pm
    tty: true
    stdin_open: true
    environment:
      - EXOMONAD_ROLE=pm
      - CONTROL_SERVER_URL=http://control-server:7432
      - EXOMONAD_CONTROL_SOCKET=/sockets/control.sock
    volumes:
      - exomonad-worktrees:/workspace
      - exomonad-sockets:/sockets
      - exomonad-claude-auth:/home/agent/.claude
      - exomonad-gh-auth:/home/agent/.config/gh
    depends_on:
      control-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'node.*claude' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 30s
    restart: on-failure:5
    networks:
      - exomonad-internal

  # ===========================================================================
  # OpenObserve: Observability backend (optional)
  # ===========================================================================
  openobserve:
    profiles: ["monitoring"]
    init: true
    image: public.ecr.aws/zinclabs/openobserve:latest
    container_name: exomonad-openobserve
    restart: on-failure:5
    ports:
      - "5080:5080"
      - "5081:5081"
    environment:
      - ZO_DATA_DIR=/data
      - ZO_ROOT_USER_EMAIL=${OPENOBSERVE_EMAIL:-admin@exomonad.local}
      - ZO_ROOT_USER_PASSWORD=${OPENOBSERVE_PASSWORD:-exomonad-dev}
      - ZO_MAX_FILE_SIZE_IN_MEMORY=128
      - ZO_MEMORY_CACHE_MAX_SIZE=256
      - ZO_FILE_MOVE_THREAD_NUM=1
    volumes:
      - exomonad-openobserve:/data
    networks:
      - exomonad-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5080/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ===========================================================================
  # DEPRECATED: Orchestrator (kept for rollback)
  # ===========================================================================
  orchestrator:
    extends:
      file: compose.base.yml
      service: docker-socket-access
    init: true
    profiles: ["legacy"]
    build:
      context: .
      dockerfile: docker/orchestrator/Dockerfile
      target: orchestrator
      args:
        GIT_SHA: ${GIT_SHA:-unknown}
    container_name: exomonad-orchestrator
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    depends_on:
      control-server:
        condition: service_healthy
    tty: true
    stdin_open: true
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - HANGAR_ROOT=/worktrees
      - EXOMONAD_CONTROL_SOCKET=/sockets/control.sock
      - EXOMONAD_TUI_SOCKET=/sockets/tui.sock
      - CLAUDE_CONFIG_DIR=/home/user/.claude
      - RUST_BACKTRACE=full
      - EXOMONAD_REPO_URL=${EXOMONAD_REPO_URL:-git@github.com:exomonad-ai/exomonad.git}
      - EXOMONAD_REPO_BRANCH=${EXOMONAD_REPO_BRANCH:-main}
      - CLAUDE_CODE_DISABLE_INSTALLATION_CHECKS=1
      - DISABLE_AUTOUPDATER=1
      - DISABLE_TELEMETRY=1
    volumes:
      - exomonad-repo:/worktrees
      - exomonad-sockets:/sockets
      - exomonad-claude-auth:/home/user/.claude
      - exomonad-gh-auth:/home/user/.config/gh
      - exomonad-ssh-keys:/home/user/.ssh
      - exomonad-zellij:/run/user/1000
    restart: on-failure:5
    networks:
      - exomonad-internal
    command: ["orchestrator"]

volumes:
  exomonad-sockets:
    name: exomonad-sockets
  exomonad-claude-auth:
    name: exomonad-claude-auth
  exomonad-gh-auth:
    name: exomonad-gh-auth
  exomonad-repo:
    name: exomonad-repo
  exomonad-ssh-keys:
    name: exomonad-ssh-keys
  exomonad-zellij:
    name: exomonad-zellij
  exomonad-openobserve:
    name: exomonad-openobserve
  exomonad-worktrees:
    name: exomonad-worktrees

networks:
  exomonad-internal:
    name: exomonad-internal
    driver: bridge