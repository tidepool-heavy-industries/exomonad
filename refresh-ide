#!/bin/bash
set -euo pipefail

# =============================================================================
# ExoMonad IDE - Refresh (No TTY Required)
# =============================================================================
# Rebuilds images and recreates containers. Does NOT connect to Zellij.
#
# Use this when you've:
#   - Updated a Dockerfile
#   - Changed a layout.kdl
#   - Installed new system dependencies
#   - Need to clear stale session state
#
# After this completes, use ./ide to connect.
#
# Safe to run from agents (no TTY required).
# =============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo "Rebuilding and refreshing IDE environment..."

# 1. Detect Docker socket GID for group_add (enables docker socket access without runtime groupadd)
export DOCKER_GID=$(stat -c '%g' /var/run/docker.sock 2>/dev/null || stat -f '%g' /var/run/docker.sock 2>/dev/null || echo 999)

# 2. Auto-detect git SHA for OCI labels
export GIT_SHA="${GIT_SHA:-$(git rev-parse --short HEAD 2>/dev/null || echo unknown)}"
echo "Git SHA: $GIT_SHA"

# 3. Build all images via bake (handles multi-stage builder contexts)
#    --load: Load images into local daemon for compose to use
echo "Building images via docker bake..."
./build --load

# 4. Clean up volatile state (sockets, locks) to prevent stale container issues
#    We use a temp container to wipe shared volumes without destroying the volumes themselves
#    (preserving ownership/permissions is less critical here as entrypoint fixes them)
echo "Cleaning volatile runtime state..."
docker run --rm \
    -v exomonad-sockets:/sockets \
    -v exomonad-zellij:/run/user/1000 \
    debian:bookworm-slim \
    bash -c 'rm -rf /sockets/* /run/user/1000/*' || true

# 5. Force recreation of containers
#    --force-recreate: Essential to pick up new images even if tags haven't changed
#    and to ensure a fresh process state.
echo "Recreating containers..."
docker compose up -d --force-recreate --remove-orphans

# 6. Wait for health checks to pass
echo "Waiting for services to be healthy..."
TIMEOUT=60
ELAPSED=0
while [ $ELAPSED -lt $TIMEOUT ]; do
    # Check if all required containers are healthy
    TL_HEALTHY=$(docker inspect --format='{{.State.Health.Status}}' exomonad-tl 2>/dev/null || echo "unknown")
    PM_HEALTHY=$(docker inspect --format='{{.State.Health.Status}}' exomonad-pm 2>/dev/null || echo "unknown")
    CS_HEALTHY=$(docker inspect --format='{{.State.Health.Status}}' exomonad-control-server 2>/dev/null || echo "unknown")

    if [ "$TL_HEALTHY" = "healthy" ] && [ "$PM_HEALTHY" = "healthy" ] && [ "$CS_HEALTHY" = "healthy" ]; then
        echo "All services healthy."
        break
    fi

    sleep 2
    ELAPSED=$((ELAPSED + 2))
    echo "  Waiting... (tl=$TL_HEALTHY, pm=$PM_HEALTHY, control-server=$CS_HEALTHY)"
done

if [ $ELAPSED -ge $TIMEOUT ]; then
    echo "Warning: Timeout waiting for services to become healthy"
    echo "  tl=$TL_HEALTHY, pm=$PM_HEALTHY, control-server=$CS_HEALTHY"
fi

echo ""
echo "Refresh complete. Connect with:"
echo "  ./ide"
