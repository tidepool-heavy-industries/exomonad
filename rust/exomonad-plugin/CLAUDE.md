# exomonad-plugin

Zellij plugin for ExoMonad agent status and popup UI.

## Overview

A Zellij WASM plugin that provides:
- **Status display**: Agent state (IDLE, RUNNING, WAITING, ERROR)
- **Popup UI**: Interactive forms for RequestInput effect

## Architecture

```
Haskell WASM → Sidecar → pipe_message_to_plugin("exomonad") → Zellij plugin
                                                                    ↓
                                                            Renders popup UI
                                                                    ↓
                                                            Handles keyboard
                                                                    ↓
                                                            Returns PopupResult
```

## Plugin Messages

Plugin subscribes to:
- **CustomMessage**: Receives PopupDefinition and Status updates from sidecar
- **Key**: Handles keyboard navigation and submission

Message variants (internal PluginMessage enum):
- `Status { state, message }`: Update status display
- `Popup { request_id, definition }`: Show interactive popup
- `ClosePopup`: Dismiss current popup

## Status Display

The plugin maintains and displays agent status:

| State | Description |
|-------|-------------|
| IDLE | Agent ready for input |
| RUNNING | Agent processing request |
| WAITING | Agent waiting for user input |
| ERROR | Agent encountered an error |

**Implementation:** Status bar shows `[EXOMONAD: <state>] <message>`

## Popup Rendering

Components rendered as ASCII UI:
- **Text**: Static display (no interaction)
- **Slider**: `[====|----] 50` with arrow keys (left/right)
- **Checkbox**: `[x]` or `[ ]` with space toggle
- **Textbox**: Editable text field (type to input, backspace to delete)
- **Choice**: `> Option 1` with arrow keys (up/down)
- **Multiselect**: `[x] Option 1` with space toggles
- **Group**: Visual grouping (indentation)

### Navigation

| Key | Action |
|-----|--------|
| Tab / Shift+Tab | Move between fields |
| Enter | Submit form |
| Esc | Cancel form |
| Arrow keys (Up/Down) | Adjust choice selection |
| Arrow keys (Left/Right) | Adjust slider value |
| Space | Toggle checkbox/multiselect |
| Type characters | Input text in textbox |
| Backspace | Delete character in textbox |

### Visibility Rules

Components can be conditionally shown based on visibility rules:
- `Checked(id)`: Show if checkbox is checked
- `Equals {id, value}`: Show if choice equals value
- `GreaterThan {id, min_value}`: Show if slider >= min_value
- `LessThan {id, max_value}`: Show if slider <= max_value
- `CountEquals {id, exact_count}`: Show if multiselect has exact count
- `CountGreaterThan {id, min_count}`: Show if multiselect has >= min_count

**Implementation:** Plugin evaluates visibility rules on every state change and only renders visible components.

## Building

```bash
cargo build -p exomonad-plugin --target wasm32-wasi --release
```

**Output:** `target/wasm32-wasi/release/exomonad-plugin.wasm`

**Requirements:**
- `wasm32-wasi` target installed: `rustup target add wasm32-wasi`
- Zellij plugin API dependencies (zellij-tile crate)

## Deployment

Install to Zellij plugins directory:
```bash
mkdir -p ~/.config/zellij/plugins
cp target/wasm32-wasi/release/exomonad-plugin.wasm ~/.config/zellij/plugins/
```

Load in Zellij layout (KDL):
```kdl
plugin location="file:~/.config/zellij/plugins/exomonad-plugin.wasm"
```

**Note:** The plugin is typically loaded via KDL layouts generated by `zellij-gen`, not manually added to layouts.

## Testing

```bash
# Build and test locally
cargo build -p exomonad-plugin --target wasm32-wasi
cargo test -p exomonad-plugin

# Manual testing in Zellij:
# 1. Build plugin
# 2. Copy to ~/.config/zellij/plugins/
# 3. Start Zellij session
# 4. Send CustomMessage via exomonad
```

**Integration testing:**
1. Run exomonad with Haskell WASM
2. Trigger RequestInput effect
3. Verify popup renders correctly
4. Interact with form (keyboard navigation)
5. Verify PopupResult returned to WASM

## Design Notes

- **Single plugin**: Handles both status bar and popups (not separate plugins)
- **Protocol types**: Uses exomonad-ui-protocol for shared PopupDefinition types
- **Event subscription**: CustomMessage for data, Key for interaction
- **WASM target**: wasm32-wasi (Zellij plugin API requirement)
- **Stateful**: Maintains popup state across render cycles
- **ASCII rendering**: No graphics, pure text-based UI (Zellij limitation)
- **Keyboard-only**: No mouse support (Zellij limitation)

## Communication Protocol

**Sidecar → Plugin (CustomMessage):**
```rust
let message = serde_json::to_string(&PluginMessage::Popup {
    request_id: "req-123".to_string(),
    definition: popup_def,
})?;

pipe_message_to_plugin(
    MessageToPlugin::new("exomonad")
        .with_payload(message)
);
```

**Plugin → Sidecar (via temporary file):**
```rust
let result = PopupResult {
    button: "submit".to_string(),
    values: state.to_json(),
    time_spent_seconds: Some(12),
};

// Write to /tmp/exomonad-popup-result-<request_id>.json
```

**Note:** Communication is one-way (sidecar → plugin) via pipe, return data via temp file.

## Related Documentation

- [exomonad-ui-protocol](../exomonad-ui-protocol/CLAUDE.md) - Shared protocol types
- [Zellij Plugin API](https://zellij.dev/documentation/plugins.html) - Zellij plugin docs
- [exomonad-runtime](../exomonad-runtime/CLAUDE.md) - Runtime that orchestrates plugin communication
- [Root CLAUDE.md](../../CLAUDE.md) - Project overview
