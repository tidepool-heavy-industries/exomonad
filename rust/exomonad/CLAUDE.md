# exomonad

Hook handler for Claude Code++ sessions.

## What This Does

Bridges Claude Code hooks to the ExoMonad control server via HTTP.

**Transport:**
- **Local dev:** HTTP over Unix Domain Socket (`.exomonad/sockets/control.sock`)
- **Docker:** HTTP over TCP (`http://control-server:7432`)

**MCP Tools:** Claude Code connects directly to control-server via HTTP. No proxy needed.

## Subcommands

### `exomonad hook <event_type> [--runtime=claude|gemini] [--role=dev|tl|pm]`

Handles Claude Code hook events. Called by hook commands in `.claude/settings.local.json`.

**Flags:**
| Flag | Default | Purpose |
|------|---------|---------|
| `--runtime` | `claude` | Runtime environment (Claude or Gemini CLI) |
| `--role` | `dev` | Agent role (dev, tl, pm) - enables role-specific hook logic |

**Flow:**
```
Claude Code                    exomonad hook               Control Server
    │                              │                               │
    │  hook JSON (stdin)           │                               │
    │─────────────────────────────▶│                               │
    │                              │  HTTP POST /hook (Unix socket)│
    │                              │──────────────────────────────▶│
    │                              │                               │
    │                              │  HTTP response (JSON)         │
    │                              │◀──────────────────────────────│
    │  hook response (stdout)      │                               │
    │◀─────────────────────────────│                               │
```

**Transport:** HTTP over Unix Domain Socket using `curl` subprocess.

**Event types** (from `HookEventType` enum):
| Event | Purpose |
|-------|---------|
| `pre-tool-use` | Before tool execution - can allow, deny, or modify |
| `post-tool-use` | After tool execution - can inject context |
| `notification` | Status updates from Claude |
| `stop` | Claude wants to stop |
| `subagent-stop` | Subagent (Task tool) stopping |
| `pre-compact` | Before context compaction |
| `session-start` | Session beginning |
| `session-end` | Session ending |
| `permission-request` | Permission dialog shown |
| `user-prompt-submit` | User submitted a prompt |

**Exit codes:**
- `0` = allow/continue
- `2` = deny/error (blocks Claude Code)

**Fail-closed behavior:** If `EXOMONAD_CONTROL_SOCKET` not set or connection fails, the hook command exits with error. This ensures configuration issues are caught during development.

### `exomonad health`

Check control server health via ping/pong request.

```bash
exomonad health
```

Sends a `GET /ping` request to the control server and verifies response. Useful for troubleshooting socket connectivity.

## Environment Variables

| Variable | Required | Purpose |
|----------|----------|---------|
| `EXOMONAD_CONTROL_SOCKET` | Yes | Unix socket path for control server (e.g., `.exomonad/sockets/control.sock`) |
| `RUST_LOG` | No | Tracing log level (e.g., `debug`, `exomonad=trace`) |

## Module Reference

| File | Purpose |
|------|---------|
| `main.rs` | CLI entry point, subcommand dispatch |
| `health.rs` | Health check implementation |

The `hook` subcommand uses `exomonad_shared::handle_hook()` directly, which implements the HTTP client logic in `exomonad_shared::socket`.

## Testing

```bash
cargo test -p exomonad
```

## Claude Code Configuration

To use exomonad hooks with Claude Code, add to `.claude/settings.local.json`:

```json
{
  "hooks": {
    "PreToolUse": "exomonad hook pre-tool-use",
    "PostToolUse": "exomonad hook post-tool-use"
  }
}
```

The `EXOMONAD_CONTROL_SOCKET` environment variable is set by `start-augmented.sh`.

## MCP Tools

Claude Code connects directly to control-server via HTTP (TCP port 7432).

**Local dev** (`.mcp.json`):
```json
{
  "mcpServers": {
    "exomonad": {
      "type": "http",
      "url": "http://localhost:7432/role/tl/mcp"
    }
  }
}
```

**Docker** (generated by entrypoint):
```json
{
  "mcpServers": {
    "exomonad": {
      "type": "http",
      "url": "http://exomonad-control-server:7432/role/tl/mcp"
    }
  }
}
```

Role-based endpoints filter available tools:
- `/role/tl/mcp` - Team Lead tools (full access)
- `/role/dev/mcp` - Developer tools
- `/role/pm/mcp` - Product Manager tools

## Troubleshooting

### Missing EXOMONAD_CONTROL_SOCKET

**Problem:** exomonad fails with "Connection refused" or "No such file"

**Cause:** `EXOMONAD_CONTROL_SOCKET` environment variable not set, or control server socket doesn't exist.

**Solution:**
```bash
# Verify socket exists
ls -la .exomonad/sockets/control.sock

# Ensure started via start-augmented.sh, which sets the env var
./start-augmented.sh
```

### Hook Timeout

**Problem:** Hook command times out after 300 seconds

**Cause:** Control server is unresponsive or handler is stuck

**Solution:**
1. Check control server logs in `.exomonad/logs/control-server.log`
2. Verify control-server is running and healthy
3. Check for deadlocks or infinite loops in hook handler

### curl Not Found

**Problem:** exomonad fails with "curl: command not found"

**Cause:** The socket client uses `curl` subprocess for HTTP-over-Unix-socket requests

**Solution:**
```bash
# Install curl (macOS)
brew install curl

# Install curl (Linux)
apt-get install curl
```

## Related Documentation

- **[rust/exomonad-shared/CLAUDE.md](../exomonad-shared/CLAUDE.md)** - Socket client implementation, protocol types
- **[haskell/control-server/CLAUDE.md](../../haskell/control-server/CLAUDE.md)** - HTTP server implementation, hook handlers
- **[ADR-003: MCP Tool Design Patterns](../../docs/architecture/ADR-003-MCP-Tool-Design-Patterns.md)** - Tool tier architecture

## What's Missing (TODO)

### Daemon Mode
Currently, hooks connect directly to control server. Goal: Add `exomonad daemon` that:
- Provides connection pooling for hooks
- Collects metrics to exomonad-hub
- Graceful degradation if control server unavailable

### Metrics Collection
Goal: Every hook sends metrics to exomonad-hub before/after handling.

### Configurable Fail Mode
Goal: Add `EXOMONAD_FAIL_MODE` environment variable to support fail-open in production deployments where Claude Code should work even if control server is down.
