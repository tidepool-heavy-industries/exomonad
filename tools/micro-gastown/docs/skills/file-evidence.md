# File Evidence Skill

Skill for committing changes with log evidence and opening PRs.

## Overview

The PR Filer polecat uses this skill to commit proposed changes and open
pull requests with full evidence linking back to the patterns identified.

## Usage

```bash
# File PR from changes
micro-gastown file-pr --changes changes.diff --evidence patterns.json

# Create as ready (not draft)
micro-gastown file-pr --changes changes.diff --evidence patterns.json --no-draft

# Request specific reviewers
micro-gastown file-pr --changes changes.diff --evidence patterns.json --reviewers alice bob
```

## Workflow

### 1. Branch Creation

Branch name format: `sleeptime/{date}-{pattern_type}`

Examples:
- `sleeptime/2026-01-03-slow-llm-calls`
- `sleeptime/2026-01-03-failed-transitions`
- `sleeptime/2026-01-03-mixed-patterns`

### 2. Commit Message

```
sleeptime: Reduce dmScene template token count

Patterns addressed:
- slow_llm at dmScene: 12 occurrences, avg 4200ms
- slow_llm at dmAftermath: 8 occurrences, avg 3100ms

Evidence:
- https://grafana.net/explore?query={app="exomonad"}|="llm_call"|node="dmScene"

Files changed:
- exomonad-dm/templates/dm_scene.jinja (-15 lines)
- exomonad-dm/src/DM/Graph.hs (+2 lines)

ðŸ¤– Generated by Micro-Gas Town sleeptime evolution
```

### 3. PR Body

```markdown
## Summary

This PR addresses 2 patterns identified in production logs:

| Pattern | Severity | Occurrences | Details |
|---------|----------|-------------|---------|
| slow_llm (dmScene) | warning | 12 | avg 4200ms, 3800 tokens |
| slow_llm (dmAftermath) | warning | 8 | avg 3100ms, 2900 tokens |

## Changes

### exomonad-dm/templates/dm_scene.jinja

Removed `full_faction_history` section which duplicated information
already present in `active_threats`. This reduces token count by ~800
per LLM call.

### exomonad-dm/src/DM/Graph.hs

Added fallback path from `dmAction` to `dmScene` to handle retry
scenarios more gracefully.

## Evidence

### Grafana Queries

- [dmScene slow calls](https://grafana.net/explore?query=...)
- [dmAftermath slow calls](https://grafana.net/explore?query=...)

### Sample Log Entries

```json
{"timestamp":"2026-01-02T15:32:00Z","node":"dmScene","latency_ms":5234,"tokens":4102}
{"timestamp":"2026-01-02T18:45:00Z","node":"dmScene","latency_ms":4891,"tokens":3890}
```

## Expected Impact

| Metric | Before | After (expected) | Improvement |
|--------|--------|------------------|-------------|
| dmScene latency | 4200ms avg | 3200-3600ms | 15-25% |
| dmScene tokens | 3800 avg | 3000 | 21% |

## Rollback

If metrics worsen after deployment:

```bash
git revert <commit-sha>
```

Monitor for 24h post-merge before considering this successful.

---
ðŸ¤– Generated by Micro-Gas Town sleeptime evolution

Co-Authored-By: Micro-Gas Town <sleeptime@exomonad.dev>
```

## Labels

PRs are automatically labeled:

| Label | Purpose |
|-------|---------|
| `sleeptime` | Identifies auto-evolution PRs |
| `auto-generated` | Marks non-human authored PRs |
| `needs-review` | Requires human approval |

## Output

```json
{
  "pr_url": "https://github.com/org/exomonad/pull/123",
  "branch_name": "sleeptime/2026-01-03-slow-llm-calls",
  "commit_sha": "abc123def456",
  "files_changed": [
    "exomonad-dm/templates/dm_scene.jinja",
    "exomonad-dm/src/DM/Graph.hs"
  ],
  "patterns_addressed": [
    "slow-llm-dmScene",
    "slow-llm-dmAftermath"
  ],
  "status": "draft"
}
```

## Review Guidelines

When reviewing sleeptime PRs:

1. **Check evidence links**: Verify patterns exist in Grafana
2. **Validate rationale**: Does the change address the pattern?
3. **Review expected impact**: Are the estimates reasonable?
4. **Test locally**: Run affected tests
5. **Approve or request changes**: Never auto-merge

## Example Session

```
$ micro-gastown file-pr --changes changes.diff --evidence patterns.json

Creating branch: sleeptime/2026-01-03-slow-llm-calls
Applying changes...
  - Modified: exomonad-dm/templates/dm_scene.jinja
  - Modified: exomonad-dm/src/DM/Graph.hs

Validating changes...
  - cabal build: SUCCESS
  - cabal test: SUCCESS

Committing with evidence...
  - Commit: abc123def456
  - Message: sleeptime: Reduce dmScene template token count

Pushing to origin...
  - Branch: sleeptime/2026-01-03-slow-llm-calls

Opening PR...
  - PR #123: https://github.com/org/exomonad/pull/123
  - Labels: sleeptime, auto-generated
  - Status: draft

Done! PR created as draft. Awaiting human review.
```
