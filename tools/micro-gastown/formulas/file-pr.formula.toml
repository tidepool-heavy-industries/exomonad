# File-PR Formula
# Skill: Commit changes and open PR with evidence

[formula]
name = "file-pr"
version = "0.1.0"
description = "Commit sleeptime evolution changes and open PR"
category = "git"

[input]
required = ["changes", "evidence"]
optional = ["draft", "reviewers", "labels"]

[input.changes]
type = "file"
description = "Path to unified diff file"
format = "diff"

[input.evidence]
type = "file"
description = "Path to PatternReport JSON (for PR body)"
schema = "PatternReport"

[input.draft]
type = "boolean"
description = "Create as draft PR"
default = true

[input.reviewers]
type = "array"
items = "string"
description = "GitHub usernames to request review"

[input.labels]
type = "array"
items = "string"
description = "Labels to apply to PR"
default = ["sleeptime", "auto-generated"]

[output]
type = "PRResult"
description = "PR creation result with URL and metadata"

[execution]
polecat = "pr-filer"
timeout_seconds = 60
retry_count = 1

[steps]
1 = "Generate branch name from pattern type and date"
2 = "Create branch from main"
3 = "Apply diff to working tree"
4 = "Validate changes still compile"
5 = "Commit with evidence-linked message"
6 = "Push branch to origin"
7 = "Open PR via gh CLI"

[git]
base_branch = "main"
branch_format = "sleeptime/{date}-{pattern_type}"
commit_message_format = """
sleeptime: {title}

Patterns addressed:
{pattern_summary}

Evidence: {grafana_links}

{footer}
"""
footer = "ðŸ¤– Generated by Micro-Gas Town sleeptime evolution"

[pr]
title_format = "sleeptime: {brief_description}"
body_template = """
## Summary

This PR addresses {pattern_count} patterns identified in production logs:

{pattern_table}

## Changes

{change_summary}

## Evidence

{evidence_section}

## Expected Impact

{expected_impact}

---
ðŸ¤– Generated by Micro-Gas Town sleeptime evolution
"""

[example]
command = "micro-gastown file-pr --changes changes.diff --evidence patterns.json"
output = """
{
  "pr_url": "https://github.com/org/exomonad/pull/123",
  "branch_name": "sleeptime/2026-01-03-slow-llm-calls",
  "commit_sha": "abc123",
  "files_changed": ["exomonad-dm/templates/dm_scene.jinja"]
}
"""
