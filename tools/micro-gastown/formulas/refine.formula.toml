# Refine Formula
# Skill: Draft targeted DSL changes based on pattern analysis

[formula]
name = "refine"
version = "0.1.0"
description = "Draft DSL improvements based on log pattern analysis"
category = "evolution"

[input]
required = ["patterns"]
optional = ["dry_run", "max_changes", "target_files"]

[input.patterns]
type = "file"
description = "Path to PatternReport JSON file"
schema = "PatternReport"

[input.dry_run]
type = "boolean"
description = "Preview changes without generating diff"
default = false

[input.max_changes]
type = "integer"
description = "Maximum number of files to modify"
default = 5

[input.target_files]
type = "array"
items = "string"
description = "Limit changes to these files (optional filter)"

[output]
type = "ProposedChanges"
description = "Unified diff with rationale and metrics"

[execution]
polecat = "conditional-refiner"
timeout_seconds = 180
retry_count = 1

[steps]
1 = "Load and validate PatternReport"
2 = "For each pattern, identify relevant source files"
3 = "Read current file contents"
4 = "Draft minimal targeted change"
5 = "Validate change compiles (cabal build)"
6 = "Generate unified diff with inline rationale"

[validation]
must_pass = ["cabal build", "cabal test"]
forbidden_changes = [
  "*.cabal",                 # Don't modify build config
  "flake.nix",               # Don't modify Nix config
  "deploy/wrangler.toml"     # Don't modify deploy config
]

[guardrails]
max_lines_per_file = 50
require_pattern_citation = true
require_expected_improvement = true

[example]
command = "micro-gastown refine --patterns patterns.json"
output = """
--- a/exomonad-dm/templates/dm_scene.jinja
+++ b/exomonad-dm/templates/dm_scene.jinja
@@ -15,8 +15,6 @@
 ## Scene Context

 {{ scene_description }}
-
-{{ full_faction_history }}  {# REMOVED: reduces prompt by ~800 tokens #}

 ## Current Situation


Rationale: Pattern slow_llm at dmScene (avg 4200ms, 3800 tokens).
Removing faction history reduces context. Factions are already
summarized in active_threats section.

Expected improvement: -20% latency, -800 tokens per call.
"""
