{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://exomonad.dev/schemas/ProposedChanges.json",
  "title": "ProposedChanges",
  "description": "Proposed DSL changes with rationale and expected impact",
  "type": "object",
  "required": ["changes", "patterns_addressed", "validation"],
  "properties": {
    "changes": {
      "type": "array",
      "description": "List of file changes",
      "items": {
        "$ref": "#/$defs/FileChange"
      }
    },
    "patterns_addressed": {
      "type": "array",
      "description": "Pattern IDs addressed by these changes",
      "items": {
        "type": "string"
      }
    },
    "validation": {
      "$ref": "#/$defs/Validation"
    },
    "expected_impact": {
      "$ref": "#/$defs/ExpectedImpact"
    },
    "rollback_instructions": {
      "type": "string",
      "description": "How to revert these changes"
    }
  },
  "$defs": {
    "FileChange": {
      "type": "object",
      "required": ["path", "diff", "rationale"],
      "properties": {
        "path": {
          "type": "string",
          "description": "Relative path to modified file"
        },
        "diff": {
          "type": "string",
          "description": "Unified diff for this file"
        },
        "rationale": {
          "type": "string",
          "description": "Why this change addresses the pattern"
        },
        "lines_added": {
          "type": "integer",
          "minimum": 0
        },
        "lines_removed": {
          "type": "integer",
          "minimum": 0
        },
        "change_type": {
          "type": "string",
          "enum": ["template", "schema", "graph", "handler", "config"],
          "description": "Category of change"
        }
      }
    },
    "Validation": {
      "type": "object",
      "required": ["build_success", "test_success"],
      "properties": {
        "build_success": {
          "type": "boolean",
          "description": "Whether cabal build succeeded"
        },
        "test_success": {
          "type": "boolean",
          "description": "Whether cabal test succeeded"
        },
        "build_output": {
          "type": "string",
          "description": "Build command output (if failed)"
        },
        "test_output": {
          "type": "string",
          "description": "Test command output (if failed)"
        }
      }
    },
    "ExpectedImpact": {
      "type": "object",
      "properties": {
        "metrics": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/MetricImpact"
          }
        },
        "confidence": {
          "type": "string",
          "enum": ["high", "medium", "low"],
          "description": "Confidence in the expected improvement"
        },
        "notes": {
          "type": "string",
          "description": "Additional context about expected impact"
        }
      }
    },
    "MetricImpact": {
      "type": "object",
      "required": ["metric", "before", "after_estimate"],
      "properties": {
        "metric": {
          "type": "string",
          "description": "Metric name (e.g., 'dmScene_latency_ms')"
        },
        "before": {
          "type": "number",
          "description": "Current value"
        },
        "after_estimate": {
          "type": "string",
          "description": "Expected value range (e.g., '3200-3600')"
        },
        "improvement_percent": {
          "type": "string",
          "description": "Expected improvement (e.g., '15-25%')"
        }
      }
    }
  }
}
