#!/usr/bin/env bash
# bead-context - Bootstrap context for agents working beads
#
# Usage: ./scripts/bead-context
#
# Parses bead ID from branch name (bd-{id}/*) and outputs:
# - Task assignment with acceptance criteria
# - Workflow instructions
# - Completion checklist
#
# Output is designed as prompt injection for LLM agents.

set -euo pipefail

# Get current branch
BRANCH=$(git branch --show-current 2>/dev/null)

if [[ -z "$BRANCH" ]]; then
  echo "ERROR: Not in a git repository or no branch checked out" >&2
  exit 1
fi

# Parse bead ID from branch name
# Convention: bd-{id}/{description}
if [[ "$BRANCH" =~ ^bd-([^/]+)/ ]]; then
  EXTRACTED_ID="${BASH_REMATCH[1]}"
  # Only prepend tidepool- if not already present
  if [[ "$EXTRACTED_ID" =~ ^tidepool- ]]; then
    BEAD_ID="$EXTRACTED_ID"
  else
    BEAD_ID="tidepool-$EXTRACTED_ID"
  fi
else
  echo "ERROR: Branch '$BRANCH' doesn't match bd-{id}/* convention" >&2
  echo "Expected format: bd-abc123/description" >&2
  exit 1
fi

# Get bead details (capture for parsing)
BEAD_OUTPUT=$(bd show "$BEAD_ID" 2>&1)

cat << 'HEADER'
╔═══════════════════════════════════════════════════════════════════════════════╗
║                           TASK ASSIGNMENT                                      ║
╚═══════════════════════════════════════════════════════════════════════════════╝
HEADER

echo ""
echo "You are working on: $BEAD_ID"
echo "Branch: $BRANCH"
echo "Worktree: $(pwd)"
echo ""

cat << 'DIVIDER'
┌───────────────────────────────────────────────────────────────────────────────┐
│ BEAD DETAILS                                                                   │
└───────────────────────────────────────────────────────────────────────────────┘
DIVIDER
echo ""
echo "$BEAD_OUTPUT"
echo ""

cat << WORKFLOW
┌───────────────────────────────────────────────────────────────────────────────┐
│ WORKFLOW                                                                       │
└───────────────────────────────────────────────────────────────────────────────┘

1. READ the acceptance criteria carefully
2. EXPLORE relevant code before making changes
3. IMPLEMENT incrementally, testing as you go
4. COMMIT with message: "[$BEAD_ID] <description>"
5. PUSH and file PR:
   git push -u origin $BRANCH
   gh pr create --repo tidepool-heavy-industries/tidepool --head $BRANCH \
     --title "[$BEAD_ID] <title>" --body "Closes $BEAD_ID"

WORKFLOW

cat << COMPLETE
┌───────────────────────────────────────────────────────────────────────────────┐
│ DONE WHEN                                                                      │
└───────────────────────────────────────────────────────────────────────────────┘

  □ All acceptance criteria satisfied
  □ Code compiles: cabal build all
  □ Tests pass (if applicable)
  □ Committed to branch
  □ PR filed via: gh pr create

After PR is merged, close bead:
  bd close $BEAD_ID --reason "Merged: <PR URL>"

COMPLETE

echo ""
echo "═══════════════════════════════════════════════════════════════════════════════"
echo "                              BEGIN WORK"
echo "═══════════════════════════════════════════════════════════════════════════════"
