#!/bin/bash
set -euo pipefail

# =============================================================================
# ExoMonad IDE - Connect to Zellij (TTY Required)
# =============================================================================
# Single command to enter the development environment.
#
# What this does:
#   1. Ensures containers are running (idempotent, uses cached images)
#   2. Connects to Zellij session (creates if missing, attaches if exists)
#
# If you need to rebuild images after Dockerfile/layout changes:
#   ./refresh-ide   # Rebuild + recreate (no TTY needed)
#   ./ide           # Then connect
#
# The magic is `zellij attach --create` with `--layout`:
#   - Creates session with layout if it doesn't exist
#   - Attaches to existing session if it does
#   - Resurrects session with layout if container was restarted
# =============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# 1. Detect Docker socket GID for group_add (enables docker socket access without runtime groupadd)
export DOCKER_GID=$(stat -c '%g' /var/run/docker.sock 2>/dev/null || stat -f '%g' /var/run/docker.sock 2>/dev/null || echo 999)

# 2. Auto-detect git SHA for OCI labels (used if images need to be built)
export GIT_SHA="${GIT_SHA:-$(git rev-parse --short HEAD 2>/dev/null || echo unknown)}"

# 3. Ensure containers are running (idempotent, no rebuild)
#    -d: Detached
#    --remove-orphans: Clean up old containers
echo "Ensuring containers are running..."
docker compose up -d --remove-orphans

# 4. Wait for zellij container to be ready
echo "Waiting for Zellij container..."
TIMEOUT=30
ELAPSED=0
while [ $ELAPSED -lt $TIMEOUT ]; do
    if docker exec exomonad-zellij test -S /var/run/docker.sock 2>/dev/null; then
        break
    fi
    sleep 1
    ELAPSED=$((ELAPSED + 1))
done

if [ $ELAPSED -ge $TIMEOUT ]; then
    echo "Warning: Timeout waiting for Zellij container, connecting anyway..."
fi

# 5. Connect to Zellij (idempotent: creates if missing, attaches if exists)
#    --layout: Layout to use when creating (ignored if session exists)
#    attach --create: The magic - connects if exists, creates if not
#    gosu user: Run zellij as UID 1000 so session socket is user-owned
#               This enables cross-container control via tui-spawner
echo "Connecting to Zellij session..."
exec docker exec -it \
    -e COLUMNS="$(tput cols)" \
    -e LINES="$(tput lines)" \
    -e TERM="${TERM:-xterm-256color}" \
    -e COLORTERM="${COLORTERM:-truecolor}" \
    exomonad-zellij \
    gosu user zellij --layout /etc/zellij/layouts/main.kdl \
    attach --create main
