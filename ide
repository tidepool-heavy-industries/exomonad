#!/bin/bash
set -euo pipefail

# =============================================================================
# Tidepool IDE - Idempotent Session Management
# =============================================================================
# Single command to enter the development environment.
#
# What this does:
#   1. Ensures all containers are running (idempotent)
#   2. Connects to Zellij session (creates if missing, attaches if exists)
#
# The magic is `zellij attach --create` with `--layout`:
#   - Creates session with layout if it doesn't exist
#   - Attaches to existing session if it does
#   - Resurrects session with layout if container was restarted
# =============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# 1. Ensure containers are running (idempotent)
#    -d: Detached
#    --remove-orphans: Clean up old containers
echo "Ensuring containers are running..."
docker compose up -d --remove-orphans

# 2. Wait for zellij container to be ready
echo "Waiting for Zellij container..."
TIMEOUT=30
ELAPSED=0
while [ $ELAPSED -lt $TIMEOUT ]; do
    if docker exec tidepool-zellij test -S /var/run/docker.sock 2>/dev/null; then
        break
    fi
    sleep 1
    ELAPSED=$((ELAPSED + 1))
done

if [ $ELAPSED -ge $TIMEOUT ]; then
    echo "Warning: Timeout waiting for Zellij container, connecting anyway..."
fi

# 3. Connect to Zellij (idempotent: creates if missing, attaches if exists)
#    --layout: Layout to use when creating (ignored if session exists)
#    attach --create: The magic - connects if exists, creates if not
echo "Connecting to Zellij session..."
exec docker exec -it tidepool-zellij \
    zellij --layout /etc/zellij/layouts/main.kdl \
    attach --create tidepool
