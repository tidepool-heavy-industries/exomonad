#!/usr/bin/env bash
# Wrapper for docker buildx bake that auto-injects GIT_SHA
#
# Usage:
#   ./build                    # Build all images
#   ./build control-server     # Build specific target
#   ./build --load             # Build and load into local daemon
#   ./build deps               # Build dependency cachers only
#
# This wrapper ensures GIT_SHA is always set from the current git commit.

set -euo pipefail

# Auto-detect git SHA (works in git repos and worktrees)
if git rev-parse --git-dir >/dev/null 2>&1; then
    export GIT_SHA="${GIT_SHA:-$(git rev-parse --short HEAD)}"
else
    echo "WARNING: Not a git repository. GIT_SHA will be empty."
    export GIT_SHA="${GIT_SHA:-}"
fi

echo ">>> Building with GIT_SHA=$GIT_SHA"

exec docker buildx bake --file docker/docker-bake.hcl "$@"
