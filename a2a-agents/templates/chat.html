<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Request - Reimbursement</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <main class="container">
        <h1>ðŸ’¼ Expense Reimbursement Request</h1>
        <div class="task-header-info">
            <p class="task-id">Request ID: <code>{{ task_id }}</code></p>
            {% if task_state.is_some() %}
            <span class="task-state task-state-{{ task_state.as_ref().unwrap()|lower }}">{{ task_state.as_ref().unwrap() }}</span>
            {% endif %}
        </div>

        {% if task_state.is_some() %}
        <div class="state-progression">
            <div class="progress-step {% if task_state.as_ref().unwrap() == "Submitted" || task_state.as_ref().unwrap() == "Working" || task_state.as_ref().unwrap() == "Completed" %}active{% endif %}">
                <div class="step-circle">1</div>
                <div class="step-label">Submitted</div>
            </div>
            <div class="progress-line {% if task_state.as_ref().unwrap() == "Working" || task_state.as_ref().unwrap() == "Completed" %}active{% endif %}"></div>
            <div class="progress-step {% if task_state.as_ref().unwrap() == "Working" || task_state.as_ref().unwrap() == "Completed" %}active{% endif %}">
                <div class="step-circle">2</div>
                <div class="step-label">Reviewing</div>
            </div>
            <div class="progress-line {% if task_state.as_ref().unwrap() == "Completed" %}active{% endif %}"></div>
            <div class="progress-step {% if task_state.as_ref().unwrap() == "Completed" %}active{% endif %}">
                <div class="step-circle">3</div>
                <div class="step-label">Approved</div>
            </div>
        </div>
        {% endif %}

        <!-- Notification permission banner -->
        <div id="notification-banner" class="notification-banner" style="display: none;">
            <p>ðŸ“¬ Enable notifications to get alerts when your expense is processed</p>
            <button id="enable-notifications" class="btn-primary">Enable Notifications</button>
            <button id="dismiss-banner" class="btn-secondary">Maybe Later</button>
        </div>

        <div class="chat-container">
            <div class="messages">
                {% for message in messages %}
                <div class="message message-{{ message.role|lower }}">
                    <div class="message-header">
                        <span class="role">{{ message.role }}</span>
                    </div>
                    <div class="message-content">
                        {{ message.content }}
                    </div>
                </div>
                {% endfor %}
                
                {% if messages.is_empty() %}
                <p class="no-messages">No messages yet. Send a message to start the conversation!</p>
                {% endif %}
            </div>
            
            <form action="/chat/{{ task_id }}/send" method="post" class="message-form" enctype="multipart/form-data">
                <input type="hidden" name="task_id" value="{{ task_id }}">
                <div class="input-group">
                    <input
                        type="text"
                        name="message"
                        placeholder="Type your message..."
                        required
                        autofocus
                    >
                    <label for="receipt-upload" class="file-upload-label" title="Attach receipt">
                        ðŸ“Ž
                        <input
                            type="file"
                            id="receipt-upload"
                            name="receipt"
                            accept="image/*,application/pdf"
                            style="display: none;"
                        >
                    </label>
                    <button type="submit">Send</button>
                </div>
                <div id="file-preview" class="file-preview" style="display: none;">
                    <span class="file-name"></span>
                    <button type="button" class="remove-file" onclick="removeFile()">âœ•</button>
                </div>
            </form>
        </div>
        
        <div class="actions">
            <a href="/tasks">ðŸ“‹ View All Expenses</a>
            <a href="/">âž• Submit New Expense</a>
            {% if task_state.is_some() && (task_state.as_ref().unwrap() == "Working" || task_state.as_ref().unwrap() == "Submitted") %}
            <form action="/chat/{{ task_id }}/cancel" method="post" style="display: inline;">
                <button type="submit" class="btn-danger">Cancel Request</button>
            </form>
            {% endif %}
        </div>
    </main>
    
    <script>
        const taskId = '{{ task_id }}';
        const messagesContainer = document.querySelector('.messages');
        const taskStateElement = document.querySelector('.task-state');
        const fileInput = document.getElementById('receipt-upload');
        const filePreview = document.getElementById('file-preview');
        const fileNameSpan = filePreview ? filePreview.querySelector('.file-name') : null;
        const notificationBanner = document.getElementById('notification-banner');
        const enableNotificationsBtn = document.getElementById('enable-notifications');
        const dismissBannerBtn = document.getElementById('dismiss-banner');

        // Show notification banner if permission not granted
        if ('Notification' in window && Notification.permission === 'default') {
            if (notificationBanner) {
                notificationBanner.style.display = 'block';
            }
        }

        // Handle enable notifications button
        if (enableNotificationsBtn) {
            enableNotificationsBtn.addEventListener('click', async () => {
                const permission = await Notification.requestPermission();
                console.log('Notification permission:', permission);
                if (notificationBanner) {
                    notificationBanner.style.display = 'none';
                }
                if (permission === 'granted') {
                    showNotification('Notifications Enabled', 'You will now receive updates about your expenses');
                }
            });
        }

        // Handle dismiss banner button
        if (dismissBannerBtn) {
            dismissBannerBtn.addEventListener('click', () => {
                if (notificationBanner) {
                    notificationBanner.style.display = 'none';
                }
            });
        }

        // Show browser notification
        function showNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(title, {
                    body: body,
                    icon: 'ðŸ’¼',
                    badge: 'ðŸ’¼',
                    tag: 'expense-update-' + taskId,
                    requireInteraction: false,
                    silent: false
                });

                // Close notification after 5 seconds
                setTimeout(() => notification.close(), 5000);

                // Click notification to focus window
                notification.onclick = function() {
                    window.focus();
                    this.close();
                };
            }
        }

        // Auto-scroll to bottom of messages
        function scrollToBottom() {
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        scrollToBottom();

        // File upload handling
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    const fileName = this.files[0].name;
                    if (fileNameSpan) {
                        fileNameSpan.textContent = fileName;
                    }
                    if (filePreview) {
                        filePreview.style.display = 'flex';
                    }
                }
            });
        }

        function removeFile() {
            if (fileInput) {
                fileInput.value = '';
            }
            if (filePreview) {
                filePreview.style.display = 'none';
            }
        }

        // Set up EventSource for real-time updates
        const eventSource = new EventSource(`/chat/${taskId}/stream`);

        eventSource.addEventListener('task-status', (event) => {
            try {
                const data = JSON.parse(event.data);
                console.log('Task status update:', data);

                // Update task state badge if present
                if (data.TaskStatus && data.TaskStatus.task_status) {
                    const newState = data.TaskStatus.task_status.state;
                    if (taskStateElement) {
                        taskStateElement.textContent = newState;
                        taskStateElement.className = `task-state task-state-${newState.toLowerCase()}`;
                    }
                }

                // Reload page to show new messages (simple approach)
                // In a more sophisticated app, you'd append messages to the DOM directly
                if (data.TaskStatus && data.TaskStatus.task_status.history) {
                    setTimeout(() => window.location.reload(), 500);
                }
            } catch (e) {
                console.error('Error parsing task status:', e);
            }
        });

        eventSource.addEventListener('artifact', (event) => {
            try {
                const data = JSON.parse(event.data);
                console.log('Artifact update:', data);
                // Handle artifact updates (could display inline or as download links)
            } catch (e) {
                console.error('Error parsing artifact:', e);
            }
        });

        eventSource.addEventListener('task-update', (event) => {
            try {
                const task = JSON.parse(event.data);
                console.log('Task update (polling):', task);

                // Update task state
                if (task.status && task.status.state) {
                    const newState = task.status.state;
                    if (taskStateElement) {
                        taskStateElement.textContent = newState;
                        taskStateElement.className = `task-state task-state-${newState.toLowerCase()}`;
                    }

                    // Show notification for state changes
                    if (newState === 'Completed') {
                        showNotification('Expense Processed', 'Your reimbursement request has been processed!');
                    } else if (newState === 'InputRequired') {
                        showNotification('Action Required', 'Your reimbursement needs more information');
                    }
                }

                // Check if we have new messages
                const currentMessageCount = messagesContainer.querySelectorAll('.message').length;
                const newMessageCount = task.history ? task.history.length : 0;

                if (newMessageCount > currentMessageCount) {
                    // Show notification for new messages
                    showNotification('Agent Response', 'Your reimbursement agent has responded');

                    // Reload page to show new messages
                    setTimeout(() => window.location.reload(), 1000);
                }
            } catch (e) {
                console.error('Error parsing task update:', e);
            }
        });

        eventSource.addEventListener('error', (event) => {
            console.error('EventSource error:', event);
            if (event.data) {
                try {
                    const error = JSON.parse(event.data);
                    console.error('Stream error:', error);
                } catch (e) {
                    console.error('Failed to parse error:', e);
                }
            }
        });

        eventSource.onerror = (error) => {
            console.error('EventSource connection error:', error);
            // Connection will automatically retry
        };

        // Close EventSource when page is unloaded
        window.addEventListener('beforeunload', () => {
            eventSource.close();
        });
    </script>
</body>
</html>