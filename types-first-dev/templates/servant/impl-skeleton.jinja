{# Generates a compilable Servant server skeleton with undefined handlers #}
{-# LANGUAGE DataKinds #-}
{-# LANGUAGE DeriveGeneric #-}
{-# LANGUAGE DerivingVia #-}
{-# LANGUAGE TypeOperators #-}
{-# LANGUAGE OverloadedStrings #-}

-- | {{ moduleName }} - Generated Servant server skeleton
--
-- This file was generated by the skeleton generator.
-- All handlers have undefined implementations.
module {{ moduleName }}
  ( -- * API Type
    {{ typeName }}

    -- * Server
  , server
  , app

    -- * Handlers
{% for sig in signatures %}
  , {{ sig.name }}
{% endfor %}
  ) where

import Data.Aeson (FromJSON, ToJSON)
import Data.IORef (IORef, newIORef, readIORef, modifyIORef')
import Data.Proxy (Proxy(..))
import Data.Text (Text)
import qualified Data.Map.Strict as Map
import GHC.Generics (Generic)
import Network.Wai (Application)
import Network.Wai.Handler.Warp (run)
import Servant
{% for imp in imports %}
{{ imp }}
{% endfor %}

-- ════════════════════════════════════════════════════════════════════════════
-- API Type and Data Types
-- ════════════════════════════════════════════════════════════════════════════

{{ dataType }}

-- ════════════════════════════════════════════════════════════════════════════
-- Application State
-- ════════════════════════════════════════════════════════════════════════════

-- | Application state (modify as needed for your use case)
data AppState = AppState
  { asUrls :: Map.Map Text Text  -- Example: short code -> original URL
  , asStats :: Map.Map Text Int  -- Example: short code -> hit count
  }
  deriving (Show, Eq)

-- | Initial empty state
initialState :: AppState
initialState = AppState Map.empty Map.empty

-- ════════════════════════════════════════════════════════════════════════════
-- Server Implementation
-- ════════════════════════════════════════════════════════════════════════════

-- | Servant server implementation
server :: IORef AppState -> Server {{ typeName }}
server ref = {% for sig in signatures %}{{ sig.name }} ref{% if not loop.last %} :<|> {% endif %}{% endfor %}

-- | WAI Application
app :: IORef AppState -> Application
app ref = serve (Proxy @{{ typeName }}) (server ref)

-- | Run the server (for testing)
runServer :: Int -> IO ()
runServer port = do
  ref <- newIORef initialState
  run port (app ref)

-- ════════════════════════════════════════════════════════════════════════════
-- Handler Implementations
-- ════════════════════════════════════════════════════════════════════════════

{% for sig in signatures %}
-- | {{ sig.description }}
{{ sig.name }} :: IORef AppState -> {{ sig.signature }}
{{ sig.name }} _ref = undefined  -- TODO: implement

{% endfor %}
