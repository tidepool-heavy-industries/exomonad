{# Generates a compilable Servant integration test skeleton using servant-client #}
{-# LANGUAGE DataKinds #-}
{-# LANGUAGE TypeOperators #-}
{-# LANGUAGE OverloadedStrings #-}

-- | Integration tests for {{ moduleName }} - Generated test skeleton
--
-- This file was generated by the skeleton generator.
-- All properties are placeholder stubs that pass trivially.
-- The tests agent should fill in real property implementations.
module Main where

import Control.Concurrent (forkIO, threadDelay, killThread)
import Control.Exception (bracket)
import Data.IORef (newIORef)
import Data.Proxy (Proxy(..))
import Network.HTTP.Client (newManager, defaultManagerSettings)
import Network.Wai.Handler.Warp (run)
import Servant
import Servant.Client
import Test.Hspec
import Test.QuickCheck

import {{ moduleName }}

-- ════════════════════════════════════════════════════════════════════════════
-- Generated Client Functions
-- ════════════════════════════════════════════════════════════════════════════

-- | Client functions derived from the API type
-- Note: These are derived automatically from {{ typeName }}
{% for sig in signatures %}{{ sig.name | replace("Handler", "Client") }}{% if not loop.last %} :<|> {% endif %}{% endfor %} = client (Proxy @{{ typeName }})

-- ════════════════════════════════════════════════════════════════════════════
-- Test Helpers
-- ════════════════════════════════════════════════════════════════════════════

-- | Port for test server
testPort :: Int
testPort = 8888

-- | Run an action with a test server running in the background
withTestServer :: (ClientEnv -> IO a) -> IO a
withTestServer action = bracket startServer stopServer runTest
  where
    startServer = do
      ref <- newIORef initialState
      tid <- forkIO $ run testPort (app ref)
      threadDelay 100000  -- Wait for server to start (100ms)
      pure tid

    stopServer tid = killThread tid

    runTest _tid = do
      manager <- newManager defaultManagerSettings
      let baseUrl = BaseUrl Http "localhost" testPort ""
      let clientEnv = mkClientEnv manager baseUrl
      action clientEnv

-- | Run a client action, failing the test on error
runClient :: ClientEnv -> ClientM a -> IO a
runClient env action = do
  result <- runClientM action env
  case result of
    Left err -> error $ "Client error: " <> show err
    Right val -> pure val

-- ════════════════════════════════════════════════════════════════════════════
-- Priority Property Tests (Acceptance Criteria)
-- ════════════════════════════════════════════════════════════════════════════

{% for priority in testPriorities %}
-- | {{ priority.description }}
spec_{{ priority.name }} :: ClientEnv -> Expectation
spec_{{ priority.name }} _env = do
  -- TODO: Implement this property test
  -- Hint: Use runClient env (someClient args) to make HTTP calls
  -- Example:
  --   result <- runClient env (shortenClient (ShortenRequest "https://example.com"))
  --   result `shouldSatisfy` isValidShortUrl
  pendingWith "Property not yet implemented"

{% endfor %}
-- ════════════════════════════════════════════════════════════════════════════
-- Per-Handler Unit Tests
-- ════════════════════════════════════════════════════════════════════════════

{% for sig in signatures %}
-- | Test for {{ sig.name }}: {{ sig.description }}
spec_{{ sig.name }} :: ClientEnv -> Expectation
spec_{{ sig.name }} _env = do
  -- TODO: Test {{ sig.name }}
  pendingWith "Handler test not yet implemented"

{% endfor %}
-- ════════════════════════════════════════════════════════════════════════════
-- Test Runner
-- ════════════════════════════════════════════════════════════════════════════

main :: IO ()
main = hspec $ do
  describe "{{ moduleName }} Integration Tests" $ do

    describe "Acceptance Criteria" $ do
{% for priority in testPriorities %}
      it "{{ priority.description }}" $ withTestServer spec_{{ priority.name }}
{% endfor %}

    describe "Handler Tests" $ do
{% for sig in signatures %}
      it "{{ sig.name }}: {{ sig.description }}" $ withTestServer spec_{{ sig.name }}
{% endfor %}
