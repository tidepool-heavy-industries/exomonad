# V3 Protocol Types
#
# Each role emits ONE OF its exit types. Orchestrator routes based on variant.
# Implementation: each variant compiles to a tool definition. Agent "calls" one tool.

---
# =============================================================================
# PLANNER (Node Architect)
# =============================================================================

PlannerExit:
  oneOf:
    - SpawnTree
    - InitLeaf
    - ClarificationNeeded

SpawnTree:
  description: "Spec too complex. Decomposed into children."
  route_to: System.SpawnChildren
  payload:
    childSpecs:
      type: array
      items: ChildSpec
    interfaceDefinitions:
      type: array
      items: InterfaceFile
    contractSuite:
      type: string
      description: "Path to compliance tests for children"

InitLeaf:
  description: "Spec atomic. Scaffolded locally, ready for TDD."
  route_to: System.ForkWorktrees
  payload:
    scaffoldCommit: string
    interfaceFile: string
    contractSuite: string
    testPlan:
      type: array
      items: PlannedTest

ClarificationNeeded:
  description: "Parent spec is ambiguous or contradictory."
  route_to: Parent.Planner
  payload:
    question: string
    ambiguityReference: string
    specSentence: string

---
# =============================================================================
# TEST AUTHOR (TDD Driver)
# =============================================================================

TestAuthorExit:
  oneOf:
    - EmitChallenge
    - ConcludeSuite
    - InvalidScaffold

EmitChallenge:
  description: "Next failing test case ready."
  route_to: Implementer
  payload:
    testFile: string
    testName: string
    criterionId: string
    rationale: string
    semanticHint: string?

ConcludeSuite:
  description: "All acceptance criteria covered. No more tests."
  route_to: Reviewer
  payload:
    suitePath: string
    coverageReport:
      criteriaWithTests: array
      criteriaMissing: array

InvalidScaffold:
  description: "Cannot write tests - types/interfaces missing."
  route_to: Planner
  payload:
    missingType: string
    expectedLocation: string

---
# =============================================================================
# IMPLEMENTER (Worker)
# =============================================================================

ImplementerExit:
  oneOf:
    - TestPassed
    - RequestRetry
    - BlockedDependency
    - SpecAmbiguity
    - Stuck

TestPassed:
  description: "Test is green."
  route_to: TestAuthor
  payload:
    commitHash: string
    testName: string
    iterations: number

RequestRetry:
  description: "Failed but have new strategy. Self-loop."
  route_to: Implementer
  budget_check: "if retries >= 5 then escalate to Stuck.SkillCeiling"
  payload:
    attemptCount: number
    diagnosis: string
    strategyShift:
      from: string
      to: string
    nextFocus: string

BlockedDependency:
  description: "Need code that doesn't exist."
  route_to: Planner
  payload:
    missingSymbol: string
    expectedImportPath: string
    attemptedWorkaround: string?

SpecAmbiguity:
  description: "Test contradicts requirements or spec unclear."
  route_to: Planner
  payload:
    contradictionTrace: string
    specSentence: string
    question: string

Stuck:
  description: "Cannot proceed. Sub-typed for routing."
  oneOf:
    - SkillCeiling
    - InfiniteLoop
    - SpecImpossible
    - ResourceExhausted

SkillCeiling:
  description: "Tried N times, code looks right, still fails."
  route_to: System.VerticalScale
  action: "Re-run with smarter model (Haiku → Sonnet → Opus)"
  payload:
    attempts: number
    bestAttemptDiff: string
    confidence: string

InfiniteLoop:
  description: "Keep applying same patch, not progressing."
  route_to: System.ContextReset
  action: "Wipe short-term memory, keep file state + error only"
  payload:
    cycleDetected: array
    repeatedPatches: number

SpecImpossible:
  description: "Requirements logically contradict."
  route_to: Planner.SpecChallenge
  payload:
    constraintA: string
    constraintB: string
    proof: string

ResourceExhausted:
  description: "Hit token/time/iteration budget."
  route_to: System.HumanEscalation
  payload:
    resource: "tokens" | "time" | "iterations"
    limit: number
    consumed: number

---
# =============================================================================
# REVIEWER (Gatekeeper)
# =============================================================================

ReviewerExit:
  oneOf:
    - Approve
    - RequestChanges
    - Reject

Approve:
  description: "Ship it."
  route_to: Merger
  payload:
    signOff: string
    mergeEventDraft:
      impactLevel: "TRIVIAL" | "ADDITIVE" | "BREAKING"
      changes: array

RequestChanges:
  description: "Fix these specific issues, then re-review."
  route_to: Implementer
  context_inject: "CritiqueList as high-priority constraints"
  payload:
    critiques:
      type: array
      items:
        file: string
        line: number
        issue: string
        requiredFix: string

Reject:
  description: "Fundamental problems. Back to drawing board."
  route_to: TestAuthor
  payload:
    reason: string
    missingCriteria: array
    contractViolations: array

---
# =============================================================================
# MERGER (Fold Handler)
# =============================================================================

MergerExit:
  oneOf:
    - MergeComplete
    - MergeRejected

MergeComplete:
  description: "Child folded successfully."
  route_to: System.AdvanceHead
  broadcast_to: Siblings.Rebaser
  payload:
    mergeCommit: string
    mergeEvent:
      author: string
      impactLevel: "TRIVIAL" | "ADDITIVE" | "BREAKING"
      changes: array

MergeRejected:
  description: "Child broke contract or integration tests."
  route_to: Child.Implementer
  payload:
    reason: "CONTRACT_VIOLATION" | "BUILD_FAILURE" | "INTEGRATION_FAILURE"
    details: string
    failingTests: array

---
# =============================================================================
# REBASER (Cascade Handler)
# =============================================================================

RebaserExit:
  oneOf:
    - RebaseClean
    - RebaseAdapted
    - RebaseConflict

RebaseClean:
  description: "Trivial rebase, no changes needed."
  route_to: Resume.TDDLoop
  payload:
    newBase: string

RebaseAdapted:
  description: "Breaking changes absorbed, tests still pass."
  route_to: Resume.TDDLoop
  payload:
    newBase: string
    adaptations:
      type: array
      items:
        symbol: string
        change: string

RebaseConflict:
  description: "Cannot resolve automatically."
  route_to: Parent.Planner
  payload:
    conflictFile: string
    ourChange: string
    theirChange: string
    whyUnresolvable: string

---
# =============================================================================
# ROUTING MATRIX
# =============================================================================

RoutingMatrix:
  # Format: Actor.ExitType → Action → Target

  Planner:
    SpawnTree: { action: "parallelize", target: "System.SpawnChildren", mutate: "freeze_node, await ALL_CHILDREN_DONE" }
    InitLeaf: { action: "fork", target: "TestAuthor + Implementer", mutate: "init_worktrees" }
    ClarificationNeeded: { action: "escalate", target: "Parent.Planner" }

  TestAuthor:
    EmitChallenge: { action: "dispatch", target: "Implementer", mutate: "add TestChallenge to impl context" }
    ConcludeSuite: { action: "transition", target: "Reviewer", mutate: "lock src/, run static analysis" }
    InvalidScaffold: { action: "repair", target: "Planner" }

  Implementer:
    TestPassed: { action: "loop", target: "TestAuthor", mutate: "clear current task" }
    RequestRetry: { action: "self_loop", target: "Implementer", mutate: "increment attempt_counter, append RetryStrategy", budget: "max 5" }
    BlockedDependency: { action: "escalate", target: "Planner", mutate: "check sibling exports" }
    SpecAmbiguity: { action: "escalate", target: "Planner" }
    Stuck.SkillCeiling: { action: "vertical_scale", target: "Implementer", mutate: "upgrade model" }
    Stuck.InfiniteLoop: { action: "context_reset", target: "Implementer", mutate: "wipe short-term memory" }
    Stuck.SpecImpossible: { action: "escalate", target: "Planner.SpecChallenge" }
    Stuck.ResourceExhausted: { action: "human_escalation", target: "Admin" }

  Reviewer:
    Approve: { action: "finalize", target: "Merger" }
    RequestChanges: { action: "loop", target: "Implementer", mutate: "inject CritiqueList" }
    Reject: { action: "loop", target: "TestAuthor", mutate: "flag missing criteria" }

  Merger:
    MergeComplete: { action: "broadcast", target: "Siblings.Rebaser", mutate: "advance HEAD" }
    MergeRejected: { action: "return", target: "Child.Implementer" }

  Rebaser:
    RebaseClean: { action: "resume", target: "TDDLoop" }
    RebaseAdapted: { action: "resume", target: "TDDLoop" }
    RebaseConflict: { action: "escalate", target: "Parent.Planner" }

---
# =============================================================================
# PRIORITY MAILBOX
# =============================================================================

MessagePriority:
  description: "When multiple messages arrive, process in this order"
  order:
    1: ContextShift    # "Stop everything, world broke"
    2: SemanticCritique # "You're done but wrong"
    3: TestChallenge   # "New work"
    4: StatusQuery     # "Are you alive?"

---
# =============================================================================
# ENVELOPE PATTERN
# =============================================================================

Envelope:
  description: |
    Routing envelope is small/fast. Full payload written to context store.
    Orchestrator reads envelope, recipient reads payload from disk.

  example:
    envelope:
      type: "BLOCKED_DEPENDENCY"
      severity: "BLOCKER"
      route_hint: "check_sibling_exports"

    payload_location: "context/blockers/{node_id}.json"

    full_payload:
      missingSymbol: "User.hashPassword"
      expectedLocation: "src/auth/utils.ts"
      trace: "ImportError: Module 'src/auth/utils' has no exported member 'hashPassword'"
      attemptedFix: "Tried mocking but interface forbids mocks"
