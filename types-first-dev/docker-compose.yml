# Docker-compose for types-first-dev services
#
# Services:
#   - auth-shell: Persistent container for Claude Code authentication
#   - hub: Session visualization daemon (mantle-hub)
#
# Usage:
#   docker-compose up -d                      # Start all services
#   docker-compose exec auth-shell claude login  # Authenticate (interactive)
#   # Hub UI available at http://localhost:7433/sessions
#
# To check auth status:
#   docker-compose exec auth-shell claude --version
#
# To view hub logs:
#   docker-compose logs -f hub

services:
  # Persistent container for interactive authentication
  auth-shell:
    build:
      context: ../rust
      dockerfile: mantle/Dockerfile
    image: tidepool/claude-code:latest
    container_name: tidepool-auth-shell
    stdin_open: true
    tty: true
    volumes:
      - claude-auth:/home/user/.claude
    # Keep running so volume persists and we can exec into it
    command: ["tail", "-f", "/dev/null"]
    restart: unless-stopped

  # Session visualization daemon
  hub:
    build:
      context: ../rust
      dockerfile: mantle-hub/Dockerfile
    image: tidepool/mantle-hub:latest
    container_name: tidepool-hub
    ports:
      - "7433:7433"
    volumes:
      - hub-data:/home/hub/.tidepool
    environment:
      - RUST_LOG=info
    restart: unless-stopped

volumes:
  # Shared authentication credentials
  # Mantle mounts this into worker containers via config
  claude-auth:
    name: tidepool-claude-auth

  # Hub SQLite database persistence
  hub-data:
    name: tidepool-hub-data
