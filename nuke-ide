#!/bin/bash
set -euo pipefail

# =============================================================================
# ExoMonad IDE - Nuke (Preserves Volumes)
# =============================================================================
# Aggressively stops and removes all project-related containers.
# Preserves persistent volumes (repo, auth, etc.).
# =============================================================================

echo "Nuking IDE containers..."

# 1. Stop Compose services (preserves volumes)
echo "Stopping compose services..."
docker compose down --remove-orphans

# 2. Kill any spawned agent containers (managed by docker-ctl, not compose)
echo "Hunting for stray agents..."
# List containers matching 'exomonad-agent-*' and kill them
AGENTS=$(docker ps -a --filter "name=exomonad-agent-" --format "{{.ID}}")

if [ -n "$AGENTS" ]; then
    echo "Killing stray agents: $AGENTS"
    echo "$AGENTS" | xargs docker rm -f
else
    echo "No stray agents found."
fi

# 3. Clean volatile state (sockets/locks) inside volumes
#    Similar to refresh-ide, but without the rebuild overhead
echo "Cleaning volatile runtime state..."
docker run --rm \
    -v exomonad-sockets:/sockets \
    -v exomonad-zellij:/run/user/1000 \
    debian:bookworm-slim \
    bash -c 'rm -rf /sockets/* /run/user/1000/*' || true

echo "Nuke complete. System is clean (volumes intact)."
echo "To restart: ./ide"
