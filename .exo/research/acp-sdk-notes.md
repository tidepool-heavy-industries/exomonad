# ACP (Agent Client Protocol) Rust SDK Research Notes

## 1. ClientSideConnection::new()
The `ClientSideConnection::new()` function is the entry point for establishing a client-side connection to an AI agent.

### Arguments
- **`client`**: `impl MessageHandler<ClientSide> + Send + Sync + 'static`.
    - This is typically a struct that implements the `Client` trait.
    - Any type `T: Client + Send + Sync` automatically implements `MessageHandler<ClientSide>`.
- **`outgoing_bytes`**: `impl Unpin + AsyncWrite + Send`.
    - This is the stream used to send data to the agent (e.g., agent's `stdin`).
    - Often a `tokio::process::ChildStdin` wrapped with `TokioAsyncWriteCompatExt::compat_write()`.
- **`incoming_bytes`**: `impl Unpin + AsyncRead + Send`.
    - This is the stream used to receive data from the agent (e.g., agent's `stdout`).
    - Often a `tokio::process::ChildStdout` wrapped with `TokioAsyncReadCompatExt::compat()`.
- **`spawn`**: `impl Fn(BoxFuture<'static, ()>) + Send + Sync + 'static`.
    - A callback function that allows the RPC layer to spawn background tasks.
    - Example: `|fut| { tokio::spawn(fut); }`.

### Returns
- `(Self, impl Future<Output = Result<()>>)`:
    - `Self`: The `ClientSideConnection` instance used to make requests (implements the `Agent` trait).
    - `impl Future`: An I/O future that manages the underlying communication. **This future must be spawned/run separately** to handle the RPC messaging.

---

## 2. Full Lifecycle
The ACP lifecycle typically follows this sequence:

1.  **Handshake (`initialize`)**:
    - The client calls `conn.initialize(InitializeRequest { ... })`.
    - The agent returns an `InitializeResponse` containing its version and capabilities.
2.  **Session Setup (`new_session`)**:
    - The client calls `conn.new_session(NewSessionRequest { ... })`.
    - The agent returns a `session_id`, which is used for all subsequent interactions.
3.  **Prompt Turn (`prompt`)**:
    - The client sends a `PromptRequest` with the user's message.
    - **Synchronous Response**: The `prompt` call returns a `PromptResponse`, indicating the reason for stopping (e.g., `EndTurn`, `ToolCalls`, `Cancelled`).
    - **Asynchronous Updates**: Real-time content (message chunks, tool call notifications) is delivered via the `Client::session_notification` callback.
4.  **Completion**:
    - The agent completes the turn, or the client initiates a `cancel`.

---

## 3. Client Trait & session_notification
The `Client` trait defines the interface that an ACP-compliant client (e.g., an IDE) must implement to receive callbacks from the agent.

### session_notification Callback
- **Signature**: `async fn session_notification(&self, args: SessionNotification) -> Result<()>`.
- **Purpose**: A notification endpoint (no response expected) for real-time session updates.
- **Payload**: `SessionNotification` contains an `update` field, which is a `SessionUpdate` enum.
- **Common Updates**:
    - `AgentMessageChunk`: Contains content blocks (text, images, resource links) generated by the agent.
    - `ToolCallRequest`: Notifies the client that the agent is initiating a tool call.
    - `ExecutionPlan`: Details about how the agent plans to proceed.

---

## 4. Usage Patterns

### Standard implementation (`agent-client-protocol`)
- See `examples/client.rs`.
- Uses `ClientSideConnection` directly.
- Requires manual management of the I/O future.
- Uses a trait-based approach (`impl Client for MyClient`).

### High-level implementation (`sacp`)
- See `src/sacp/examples/yolo_one_shot_client.rs`.
- Uses `JrHandlerChain` and `ByteStreams` for a more functional style.
- Handlers are registered via `.on_receive_notification(...)` and `.on_receive_request(...)`.
- Orchestration is handled via `.with_client(transport, |cx| async { ... })`.

---

## Key Files
- `vendor/acp-rust-sdk/src/agent-client-protocol/src/lib.rs`: Main entry points and connection structs.
- `vendor/acp-rust-sdk/src/agent-client-protocol/src/client.rs`: `Client` trait definition.
- `vendor/acp-rust-sdk/src/agent-client-protocol/src/rpc.rs`: Low-level RPC and `MessageHandler` trait.
- `vendor/acp-rust-sdk/examples/client.rs`: Standard client example.
- `vendor/acp-rust-sdk/src/sacp/examples/yolo_one_shot_client.rs`: SACP functional client example.
