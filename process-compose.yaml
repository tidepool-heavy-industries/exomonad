version: "0.5"
log_location: .tidepool/logs

processes:
  control-server:
    command: |
      # Discover Hangar by walking up directories
      HANGAR_ROOT=$(pwd)
      while [ ! -f "$HANGAR_ROOT/Hangar.toml" ] && [ "$HANGAR_ROOT" != "/" ] && [ "$HANGAR_ROOT" != "$HOME" ]; do
        HANGAR_ROOT=$(dirname "$HANGAR_ROOT")
      done
      if [ ! -f "$HANGAR_ROOT/Hangar.toml" ]; then
        echo "ERROR: Hangar.toml not found" >&2
        exit 1
      fi
      BIN_DIR="$HANGAR_ROOT/runtime/bin"
      rm -f .tidepool/sockets/control.sock .tidepool/sockets/tui.sock && \
      "$BIN_DIR/tidepool-control-server" --no-tui
    working_dir: "."
    environment:
      - "TIDEPOOL_CONTROL_SOCKET=.tidepool/sockets/control.sock"
      - "TIDEPOOL_TUI_SOCKET=.tidepool/sockets/tui.sock"
    readiness_probe:
      exec:
        # Socket existence check (no connection attempt - avoids JSON parse errors)
        command: "test -S .tidepool/sockets/control.sock"
      initial_delay_seconds: 2
      period_seconds: 3
      failure_threshold: 10
    availability:
      restart: on_failure
      max_restarts: 5
    shutdown:
      command: "rm -f .tidepool/sockets/control.sock .tidepool/sockets/tui.sock"
      timeout_seconds: 5
